# Silent Feed v0.3.5 发布公告

> 发布日期：2025年12月13日

## 🎉 概述

Silent Feed v0.3.5 是一个重要的 **成本架构重构和用户体验优化版本**。本次更新完成了 **多币种 AI 计费架构的彻底重构**，解决了不同货币混合计算的问题，同时大幅优化了 **冷启动引导流程** 和 **学习阶段用户体验**。

**核心改进**：
- 🏗️ **多币种成本架构**：彻底解决 USD/CNY 混合计算问题
- 🚀 **冷启动本地 AI 支持**：引导流程支持配置本地 Ollama
- 🎯 **预设方案智能联动**：AI 配置后自动应用推荐预设
- 💬 **学习阶段体验优化**：Tips 系统、温暖提示、空状态优化
- 🎨 **UI 细节打磨**：AI 卡片布局、费用图表简化、进度显示
- 🐛 **关键 Bug 修复**：抽象 provider 解析、测试连接截断警告

---

## 🏗️ 多币种 AI 成本架构重构

### 问题背景

v0.3.4 及之前版本存在严重的成本计算问题：
- ❌ **混合货币计算**：将美元和人民币直接相加（$1 + ¥1 = 2？）
- ❌ **预算检查不准确**：OpenAI 和 DeepSeek 的预算混在一起检查
- ❌ **统计口径混乱**：费用统计无法区分货币类型
- ❌ **用户困惑**：无法清晰了解各 Provider 的真实成本

### 新架构设计

#### 1. 币种感知的成本计算系统

```typescript
// 每个 Provider 有独立的货币类型
type ProviderCurrency = 'USD' | 'CNY' | 'FREE'

// Provider 配置示例
{
  openai: { currency: 'USD', costPerInputToken: 0.00015 },
  deepseek: { currency: 'CNY', costPerInputToken: 0.000001 },
  ollama: { currency: 'FREE', costPerInputToken: 0 }
}
```

#### 2. 分币种统计和展示

- ✅ **CollectionStats（统计概览）**：分别显示 USD 和 CNY 总成本，零值自动隐藏
- ✅ **AIUsageBarChart（使用量图表）**：费用按币种堆叠展示，工具提示标注货币
- ✅ **BudgetOverview（预算概览）**：每个 Provider 独立预算追踪
- ✅ **CSV 导出**：新增 Currency 列，明确标注每条记录的货币类型

#### 3. 费用图表 UI 优化

- 移除顶部的 USD/CNY 最大值提示（减少视觉干扰）
- 移除列内的 25/50/75% 虚线辅助线
- 移除按用途的输入/输出细分，仅显示币种总额
- 货币格式化统一：`$1.23` (USD) / `¥1.23` (CNY) / `免费` (FREE)

#### 4. 技术实现

- **CostCalculator 工厂模式**：为每个 Provider 创建专用计算器
- **AIUsageTracker 扩展**：新增 `getTotalCostByCurrency()` 方法
- **BudgetChecker 重构**：按币种合计月度成本，安全回退
- **类型安全**：`ProviderCurrency` 枚举确保编译时检查
- **架构文档**：新增 `docs/AI_COST_ARCHITECTURE.md`

---

## 🚀 冷启动引导流程优化

### 本地 Ollama 支持

v0.3.4 的引导流程只支持远程 AI（DeepSeek/OpenAI），v0.3.5 新增本地 AI 支持：

- ✅ **Step 2 新增"本地 Ollama"选项**
- ✅ **自动检测本地 AI 服务可用性**
- ✅ **连接成功后自动保存配置并标记可用**
- ✅ **本地测试成功后显示模型载入状态**
- ✅ **与远程流程一致，需测试通过后方可进入下一步**

### 预设方案智能联动

配置 AI 后自动应用推荐的预设方案：

| AI 类型 | 推荐预设 | 说明 |
|---------|----------|------|
| DeepSeek/OpenAI | 智能优先（远程优先） | 利用远程 AI 的强大能力 |
| Ollama | 隐私优先（本地优先） | 数据不出本地 |

- ✅ **新增 `hasAnyAIAvailable()` 全局检测函数**
- ✅ **新增 `getRecommendedPreset()` 智能推荐函数**
- ✅ **修复预设选择不持久化的 bug**
- ✅ **修复 provider 状态不同步的 bug**

### 引导流程 UI 改进

- ✅ **Step 2 改为单一引擎下拉选择**（简化操作）
- ✅ **无 AI 配置时隐藏预设/高级配置，显示提示卡片**
- ✅ **底部统一导航：跳过/下一步与上一步同行**

---

## 💬 学习阶段用户体验优化

### Tips 系统

新增产品提示系统，帮助用户了解 Silent Feed：

- ✅ **16 条产品提示**（理念/隐私/技巧/原理/特色）
- ✅ **学习阶段优先展示工作原理类 Tips**
- ✅ **推荐阶段优先展示使用技巧类 Tips**
- ✅ **支持中英文国际化**
- ✅ **提示卡片表情统一为 💡**

### 学习阶段展示优化

- ✅ **显示学习进度**：`X/100 页` + 进度条
- ✅ **隐私说明**：强调数据本地处理
- ✅ **5 条随机化鼓励消息**：更温暖、人性化
- ✅ **使用 🌱 图标**：符合"成长"的意境

### 空窗期（已读完）优化

- ✅ **随机显示鼓励消息**："恭喜，您已从信息洪流中解脱" 等
- ✅ **符合产品宗旨**：让信息流安静下来
- ✅ **给予正向反馈**：不催促用户添加更多订阅源

### 空状态消息优化

- **无 RSS 源**：提示用户添加订阅源
- **有 RSS 源且已读完**：随机显示鼓励消息
- **学习阶段**：显示学习进度和隐私说明

---

## 🎨 UI/UX 改进

### AI 提供商卡片优化

- ✅ **图标布局重组**
  - 状态图标（🟢🔴⚪）移到左侧，紧邻名称
  - 类型和特性图标（☁️🔬⭐🔵）右对齐显示
- ✅ **帮助光标**：所有图标添加 `cursor-help`，提升可发现性
- ✅ **垂直对齐**：使用 `items-center` 实现居中对齐
- ✅ **按钮固定底部**：检测/配置按钮始终在卡片底部

### RSS 示例源优化

- ✅ **一键订阅**：点击示例源直接订阅（无需再点"添加"按钮）
- ✅ **真实源名称**：使用真实 RSS feed 标题（Hacker News, 奇客Solidot）
- ✅ **防止重复订阅**

### 进度显示优化

- ✅ **生成中头像颜色**：紫色（推理模式）/ 蓝色（标准模式），不再使用红色
- ✅ **每日用量统计颜色**：推理深色、非推理浅色，提高对比度

---

## 🐛 Bug 修复

### 抽象 Provider 解析问题

**问题**：配置中使用抽象 provider 类型（`'remote'`, `'local'`）未正确解析为具体 provider（`'deepseek'`, `'openai'`, `'ollama'`），导致无法读取用户配置的超时值，进度条显示错误。

**修复**：
- ✅ 创建统一工具函数 `resolveProvider()` 处理抽象类型解析
- ✅ 修复 `ProfileSettings.tsx` 进度条超时计算
- ✅ 修复 `AIConfigPanel.tsx` 的 `activeProvider` 计算
- ✅ 新增 `ai-provider-resolver.test.ts`（12 个测试）

### 测试连接截断警告

**问题**：DeepSeek/OpenAI 测试连接时触发截断警告（`maxTokens` 设置为 100 太小）。

**修复**：
- ✅ 将 `maxTokens` 从 100 提升到 200
- ✅ 仅当 `maxTokens > 200` 时才显示截断警告

### "在用"状态显示错误

**问题**：未配置的 AI Provider 错误显示"在用"状态。

**修复**：
- ✅ 增强 `AIConfigPanel` 逻辑，仅当 provider 实际配置了才标记为"在用"
- ✅ 新增 `isProviderConfigured()` 检查函数

### 国际化问题

- ✅ 修正翻译文件中的错误
- ✅ 修正国际化键值不一致问题
- ✅ 完善中英文对照

---

## 📊 测试与质量

### 测试覆盖率

| 指标 | 数值 |
|------|------|
| 测试总数 | 1691 passing (102 files) |
| 行覆盖率 | 71.94% |
| 函数覆盖率 | 74.7% |
| 分支覆盖率 | 60.39% |

### 新增/更新测试

- `ai-provider-resolver.test.ts`（12 个测试）
- 成本计算相关测试全部更新
- AIConfigPanel 测试适配新逻辑
- OnboardingView 测试更新

---

## 🔄 升级指南

### 从 v0.3.4 升级

1. **自动迁移**
   - AI 配置自动迁移到新结构
   - 费用统计自动按币种分组
   - 无需手动操作

2. **建议操作**
   - 检查各 Provider 的预算设置（现在是独立的）
   - 查看分币种费用统计
   - 如需体验新引导流程，可在设置中重置 onboarding

3. **兼容性**
   - 完全向后兼容 v0.3.4
   - 旧数据自动升级

---

## 📚 相关文档

- [用户手册](./USER_GUIDE_ZH.md)
- [AI 成本架构](./AI_COST_ARCHITECTURE.md)
- [测试指南](./TESTING.md)
- [Changelog](../CHANGELOG.md)

---

## 🔗 链接

- **GitHub**: https://github.com/wxy/SilentFeed
- **Issues**: https://github.com/wxy/SilentFeed/issues
- **Releases**: https://github.com/wxy/SilentFeed/releases/tag/v0.3.5

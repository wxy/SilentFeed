# 翻译功能浏览器测试指南（更新版）

## 功能概述

Silent Feed 新增了 AI 翻译功能，可以自动将推荐内容翻译为界面语言。

### 核心特性
- ✅ 自动翻译推荐标题和摘要
- ✅ 由 AI 自动识别源语言
- ✅ 目标语言自动使用界面语言
- ✅ **语言代码标签**（EN/ZH/JA 等）点击切换原文/译文
- ✅ **不同背景色**区分原文（蓝色）和译文（绿色）
- ✅ **兜底策略**：启用翻译后，旧推荐自动即时翻译
- ✅ **禁用翻译时显示原文**：即使有翻译也显示原文
- ✅ 翻译结果存储在推荐条目中
- ✅ 设置页面提供开关控制

### 新增功能亮点

#### 1. 智能兜底翻译
**场景**：用户先生成了英文推荐，后来开启了自动翻译。

**行为**：
- 旧推荐在显示时自动检测到需要翻译
- 后台即时翻译并更新数据库
- 语言标签显示 "..." 翻译中状态（黄色背景）
- 翻译完成后自动切换为译文（绿色背景 ZH）

#### 2. 语言代码标签
**设计**：
- 显示当前显示文本的语言代码（EN, ZH, JA, KO, FR, DE, ES）
- **原文**：蓝色背景 + 蓝色文字（`bg-blue-100 text-blue-700`）
- **译文**：绿色背景 + 绿色文字（`bg-green-100 text-green-700`）
- **翻译中**：黄色背景 + 黄色文字（`bg-yellow-100 text-yellow-700`）
- 点击切换显示语言

#### 3. 禁用翻译时的行为
**场景**：用户关闭了自动翻译开关

**行为**：
- 所有推荐显示原文，即使数据库中有翻译
- 语言标签显示原文语言（蓝色）
- 无法切换到译文（符合用户意图）

## 测试前准备

### 1. 加载扩展

```bash
# 构建目录
build/chrome-mv3-prod/
```

按照 [HOW_TO_LOAD_EXTENSION.md](./HOW_TO_LOAD_EXTENSION.md) 加载扩展。

### 2. 配置 AI

1. 打开设置页面（右键扩展图标 → 设置）
2. 切换到「AI 引擎」标签
3. 配置 DeepSeek 或 OpenAI API Key
4. 启用 AI 推荐

### 3. 订阅非中文 RSS 源

为了测试翻译功能，需要订阅一些非中文的 RSS 源：

**推荐测试源**：
- Hacker News: `https://hnrss.org/frontpage`
- TechCrunch: `https://techcrunch.com/feed/`
- The Verge: `https://www.theverge.com/rss/index.xml`

## 测试步骤

### 测试 1: 基础翻译功能

**目标**：验证翻译功能是否正常工作

1. **启用自动翻译**
   - 打开设置页面
   - 切换到「偏好设置」标签
   - 勾选「自动翻译推荐」
   - ✅ **预期**：开关状态保存成功

2. **生成推荐**
   - 点击弹窗的「马上推荐」按钮
   - 等待推荐生成（可能需要几秒）
   - ✅ **预期**：
     - 后台日志显示「🌐 自动翻译已启用」
     - 推荐列表显示翻译后的内容（英文 → 中文）

3. **检查翻译质量**
   - 查看标题翻译是否准确
   - 查看摘要翻译是否流畅
   - ✅ **预期**：翻译符合原文语义，无明显机翻痕迹

### 测试 2: 语言标签切换

**目标**：验证语言代码标签和切换功能

1. **查看语言标签**
   - 打开弹窗查看推荐
   - 找到有翻译的推荐条目
   - ✅ **预期**：
     - 推荐信息栏显示语言代码标签（如 `ZH`）
     - 译文标签：绿色背景 + 绿色文字
     - 原文标签：蓝色背景 + 蓝色文字

2. **切换到原文**
   - 点击绿色的 `ZH` 标签
   - ✅ **预期**：
     - 标题和摘要切换为原文（英文）
     - 标签变为蓝色 `EN`
     - Tooltip 显示「显示译文 (ZH)」

3. **切换回译文**
   - 再次点击蓝色的 `EN` 标签
   - ✅ **预期**：
     - 标题和摘要切换为译文（中文）
     - 标签变为绿色 `ZH`
     - Tooltip 显示「显示原文 (EN)」

### 测试 3: 兜底翻译策略

**目标**：验证旧推荐的即时翻译

1. **生成未翻译的推荐**
   - 确保自动翻译**关闭**
   - 生成几条英文推荐
   - ✅ **预期**：推荐显示英文原文，无语言标签

2. **启用自动翻译**
   - 打开设置 → 偏好设置
   - 勾选「自动翻译推荐」
   - 返回弹窗

3. **观察即时翻译**
   - ✅ **预期**：
     - 语言标签出现，初始显示黄色 `...`（翻译中）
     - 几秒后标签变为绿色 `ZH`
     - 标题和摘要自动变为中文
     - 后台日志：「检测到需要即时翻译」「即时翻译推荐」

4. **验证数据库更新**
   - 打开 DevTools → IndexedDB → recommendations
   - 查看刚才的推荐条目
   - ✅ **预期**：`translation` 字段已填充

### 测试 4: 禁用翻译后的行为

**目标**：验证禁用翻译开关后的表现

1. **有翻译的推荐**
   - 确保推荐已翻译（数据库中有 translation）
   - ✅ **预期**：当前显示译文（绿色 `ZH` 标签）

2. **关闭自动翻译**
   - 打开设置 → 偏好设置
   - 取消勾选「自动翻译推荐」
   - 返回弹窗

3. **验证显示原文**
   - ✅ **预期**：
     - 所有推荐切换为原文（英文）
     - 语言标签变为蓝色 `EN`
     - 点击标签无反应（禁用切换）
     - 数据库中的翻译保留，但不显示

4. **重新启用翻译**
   - 再次勾选「自动翻译推荐」
   - ✅ **预期**：
     - 推荐立即切换回译文（绿色 `ZH`）
     - 无需重新翻译（使用已有翻译）

### 测试 5: 源语言检测

**目标**：验证 AI 能否正确识别源语言

测试不同语言的 RSS 源：
- 日文源（如果有）
- 韩文源（如果有）
- 法文源（如果有）

✅ **预期**：翻译结果中 `sourceLanguage` 字段正确

### 测试 6: 成本提示

**目标**：验证用户是否看到成本警告

1. **查看设置说明**
   - 打开设置 → 偏好设置
   - 查看「自动翻译推荐」选项下方的说明
   - ✅ **预期**：
     - 显示成本警告（约 30%）
     - 显示切换提示

## 错误场景测试

### 错误 1: AI 未配置

**操作**：
1. 清空 AI API Key
2. 启用自动翻译
3. 生成推荐

✅ **预期**：
- 后台日志：「AI 未配置，无法翻译」
- 推荐显示原文（降级处理）
- 不影响推荐生成

### 错误 2: 翻译失败

**操作**：
1. 使用无效的 API Key
2. 启用自动翻译
3. 生成推荐

✅ **预期**：
- 后台日志：「❌ 翻译失败」
- 推荐显示原文（降级处理）
- 不影响推荐生成

## 性能检查

### 1. 翻译速度

**测试**：生成 3 条推荐，观察翻译耗时

✅ **预期**：
- 单条翻译 < 2 秒
- 总耗时 < 10 秒

### 2. 成本估算

**公式**：
- DeepSeek：约 ¥0.002/条（标题 + 摘要）
- OpenAI：约 $0.0001/条

**测试**：生成 10 条推荐，检查 token 消耗

✅ **预期**：
- 成本约为推荐生成的 30%
- 符合预期范围

## 数据检查

### 1. 数据库存储

**操作**：
1. 生成翻译推荐
2. 打开浏览器 DevTools
3. 查看 IndexedDB → recommendations

✅ **预期**：每条推荐的 `translation` 字段包含：
```json
{
  "sourceLanguage": "en",
  "targetLanguage": "zh-CN",
  "translatedTitle": "翻译后的标题",
  "translatedSummary": "翻译后的摘要",
  "translatedAt": 1234567890
}
```

### 2. 数据清理

**操作**：
1. 标记推荐为「不想读」
2. 检查 IndexedDB

✅ **预期**：
- 推荐记录保留（软删除）
- 翻译数据随之保留

## 已知限制

1. **语言检测精度**：
   - AI 识别源语言准确率约 95%
   - 短文本可能误判
   - 降级方案：本地正则检测

2. **翻译质量**：
   - 依赖 AI 模型能力
   - DeepSeek：较好
   - GPT-4o-mini：优秀

3. **成本控制**：
   - 每条推荐增加约 30% 成本
   - 建议谨慎启用（仅在需要时开启）

## 测试检查清单

- [ ] 启用/禁用自动翻译开关
- [ ] 翻译后内容显示正确
- [ ] **语言代码标签显示正确（EN/ZH/JA 等）**
- [ ] **原文标签为蓝色，译文标签为绿色**
- [ ] **翻译中状态显示黄色 "..."**
- [ ] 原文/译文切换流畅
- [ ] **兜底翻译：旧推荐自动即时翻译**
- [ ] **禁用翻译时显示原文（即使有翻译）**
- [ ] 界面语言切换后翻译目标语言自动更新
- [ ] AI 未配置时降级处理
- [ ] 翻译失败时降级处理
- [ ] 成本警告显示正确
- [ ] 数据库存储结构正确
- [ ] 性能符合预期（< 10s）
- [ ] 不影响现有推荐功能

## UI 效果预览

### 语言标签样式
```
原文（英文）：[🟦 EN]  蓝色背景
译文（中文）：[🟩 ZH]  绿色背景
翻译中：    [🟨 ...]  黄色背景
```

### 切换流程
```
1. 初始状态（英文推荐，已翻译）
   显示译文 → [🟩 ZH]

2. 点击标签
   显示原文 → [🟦 EN]

3. 再次点击
   显示译文 → [🟩 ZH]
```

### 兜底翻译流程
```
1. 旧推荐（未翻译）
   显示原文 → 无标签

2. 启用自动翻译
   显示原文 → [🟨 ...]  开始翻译

3. 翻译完成
   显示译文 → [🟩 ZH]
```

## 反馈

如果发现问题，请记录：
1. **复现步骤**
2. **预期行为**
3. **实际行为**
4. **浏览器控制台日志**（过滤：[Translation]）
5. **截图**（如有）

## 下一步

测试通过后：
- [ ] 更新 README.md 添加翻译功能说明
- [ ] 更新 CHANGELOG.md 记录新功能
- [ ] 提交代码到仓库
- [ ] 准备发布新版本

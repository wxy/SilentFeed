# Phase 7.1: å›¾æ ‡ä¼˜å…ˆçº§ä¿®å¤ä¸æ¨èæ•°å­—æ˜¾ç¤º

## ğŸ“… æ—¥æœŸ
2025-11-22

## ğŸ¯ ç›®æ ‡
ä¿®å¤å›¾æ ‡ç³»ç»Ÿçš„ä¸¤ä¸ªé—®é¢˜ï¼š
1. **ä¼˜å…ˆçº§é€»è¾‘é”™è¯¯**ï¼šæ¨èé˜¶æ®µï¼ˆâ‰¥100é¡µï¼‰å›¾æ ‡ä»æ˜¾ç¤ºå­¦ä¹ è¿›åº¦é®ç½©
2. **æ¨èæ•°å­—æ˜¾ç¤º**ï¼šåœ¨æ¨èçŠ¶æ€ä¸‹å³ä¸‹è§’æ˜¾ç¤ºæ¨èæ•°é‡

## ğŸ› é—®é¢˜åˆ†æ

### é—®é¢˜ 1: æ¨èé˜¶æ®µæ˜¾ç¤ºé”™è¯¯

**ç°è±¡**ï¼š
- ç”¨æˆ·å·²å®Œæˆå­¦ä¹ é˜¶æ®µï¼ˆâ‰¥100é¡µï¼‰
- æœ‰æ–°æ¨èå†…å®¹æ—¶ï¼Œå›¾æ ‡åº”è¯¥æ˜¾ç¤ºæ³¢çº¹ + æ¨èæ•°å­—
- ä½†å®é™…æ˜¾ç¤ºçš„æ˜¯**å…¨é»‘é®ç½©**ï¼ˆå­¦ä¹ è¿›åº¦ 0% çš„æ ·å¼ï¼‰

**æ ¹æœ¬åŸå› **ï¼š
`IconManager.updateIcon()` ä¸­çš„ä¼˜å…ˆçº§é€»è¾‘é”™è¯¯ï¼š
```typescript
// âŒ é”™è¯¯é€»è¾‘
ä¼˜å…ˆçº§ 5: æ¨èé˜…è¯»
ä¼˜å…ˆçº§ 6: å­¦ä¹ è¿›åº¦  // â† å­¦ä¹ è¿›åº¦ä¼˜å…ˆçº§è¿‡ä½

// é—®é¢˜ï¼šåœæ­¢åŠ¨ç”»æ—¶é‡ç½®ä¸º { type: 'static' }
// ç”±äºå­¦ä¹ è¿›åº¦åˆ¤æ–­åœ¨æ¨èä¹‹åï¼Œå³ä½¿åœ¨æ¨èé˜¶æ®µä¹Ÿä¼šæ˜¾ç¤ºå­¦ä¹ è¿›åº¦
```

**æ­£ç¡®é€»è¾‘**ï¼š
- **å­¦ä¹ é˜¶æ®µ**ï¼ˆ<100é¡µï¼‰ï¼šæ˜¾ç¤ºå­¦ä¹ è¿›åº¦é®ç½©ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
- **æ¨èé˜¶æ®µ**ï¼ˆâ‰¥100é¡µï¼Œæœ‰æ¨èï¼‰ï¼šæ˜¾ç¤ºæ³¢çº¹ + æ•°å­—
- **æ¨èé˜¶æ®µ**ï¼ˆâ‰¥100é¡µï¼Œæ— æ¨èï¼‰ï¼šæ˜¾ç¤ºé™æ€å›¾æ ‡

### é—®é¢˜ 2: æ¨èæ•°å­—ä¸æ˜æ˜¾

**ç°è±¡**ï¼š
- æ¨èçŠ¶æ€åªæœ‰çº¢ç‚¹ï¼Œä¸å¤Ÿæ˜æ˜¾
- Chrome åŸç”Ÿ badge æ— æ³•è‡ªå®šä¹‰æ ·å¼ï¼ˆèƒŒæ™¯è‰²ä¸èƒ½åŠé€æ˜ã€å­—ä½“è¿‡å¤§ã€ä½ç½®ä¸å¯æ§ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ Canvas 2D API ç›´æ¥åœ¨å›¾æ ‡å³ä¸‹è§’ç»˜åˆ¶æ¨èæ•°å­—

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ­£ä¼˜å…ˆçº§é€»è¾‘

**æ–‡ä»¶**: `src/utils/IconManager.ts`

**å…³é”®ä¿®æ”¹**:
```typescript
// âœ… æ­£ç¡®é€»è¾‘
ä¼˜å…ˆçº§ 5: å­¦ä¹ è¿›åº¦ï¼ˆä»…å­¦ä¹ é˜¶æ®µ <100é¡µï¼‰
ä¼˜å…ˆçº§ 6: æ¨èé˜…è¯»ï¼ˆå­¦ä¹ å®Œæˆåï¼‰
ä¼˜å…ˆçº§ 7: é™æ€ï¼ˆå­¦ä¹ å®Œæˆä¸”æ— æ¨èï¼‰
```

**å®Œæ•´ä»£ç **:
```typescript
// ä¼˜å…ˆçº§ 5: å­¦ä¹ è¿›åº¦ï¼ˆå¿…é¡»åœ¨å­¦ä¹ é˜¶æ®µï¼‰
else if (this.learningProgress < LEARNING_COMPLETE_PAGES) {
  state = {
    type: 'learning',
    learningProgress: this.learningProgress,
    hasError: errorOverlay
  }
}
// ä¼˜å…ˆçº§ 6: æ¨èé˜…è¯»ï¼ˆå­¦ä¹ å®Œæˆåï¼‰
else if (this.recommendCount > 0) {
  state = {
    type: 'recommend',
    recommendCount: this.recommendCount,
    hasError: errorOverlay
  }
}
// é»˜è®¤: é™æ€ï¼ˆå­¦ä¹ å®Œæˆï¼Œæ— æ¨èï¼‰
else {
  state = {
    type: 'static',
    hasError: errorOverlay
  }
}
```

### 2. ç»˜åˆ¶æ¨èæ•°å­—å¾½ç« 

**æ–‡ä»¶**: `src/utils/IconComposer.ts`

**æ–°å¢æ–¹æ³•**: `drawRecommendBadge(count: number)`

**æ ·å¼è®¾è®¡**:
- **èƒŒæ™¯**: åŠé€æ˜æ©™è‰²åœ†å½¢ `rgba(255, 107, 0, 0.9)`
- **æè¾¹**: ç™½è‰²åŠé€æ˜ `rgba(255, 255, 255, 0.3)`
- **æ–‡å­—**: ç™½è‰²åŠ ç²—ï¼Œå¤§å°è‡ªé€‚åº”
- **ä½ç½®**: å³ä¸‹è§’ï¼Œç•™ 5% è¾¹è·
- **å¤§å°**: å¾½ç« ç›´å¾„ = å›¾æ ‡å®½åº¦ Ã— 0.35ï¼ˆçº¦å  1/3ï¼‰

**æ ¸å¿ƒä»£ç **:
```typescript
private drawRecommendBadge(count: number): void {
  const size = this.canvas.width  // 128px
  const badgeSize = size * 0.35    // 44.8px
  const padding = size * 0.05      // 6.4px
  const centerX = size - padding - badgeSize / 2
  const centerY = size - padding - badgeSize / 2
  
  // ç»˜åˆ¶åœ†å½¢èƒŒæ™¯
  this.ctx.fillStyle = 'rgba(255, 107, 0, 0.9)'
  this.ctx.beginPath()
  this.ctx.arc(centerX, centerY, badgeSize / 2, 0, Math.PI * 2)
  this.ctx.fill()
  
  // ç»˜åˆ¶ç™½è‰²æè¾¹
  this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'
  this.ctx.lineWidth = size * 0.015
  this.ctx.beginPath()
  this.ctx.arc(centerX, centerY, badgeSize / 2, 0, Math.PI * 2)
  this.ctx.stroke()
  
  // ç»˜åˆ¶æ•°å­—æ–‡æœ¬
  const fontSize = badgeSize * 0.65  // 29.12px
  this.ctx.fillStyle = '#ffffff'
  this.ctx.font = `bold ${fontSize}px -apple-system, sans-serif`
  this.ctx.textAlign = 'center'
  this.ctx.textBaseline = 'middle'
  this.ctx.fillText(count.toString(), centerX, centerY)
}
```

**è°ƒç”¨ä½ç½®**:
```typescript
// åœ¨ compose() æ–¹æ³•ä¸­
if (state.type === 'recommend' && state.recommendCount) {
  this.drawRecommendWaves(state.recommendCount)
  this.drawRecommendBadge(state.recommendCount)  // â† æ–°å¢
}
```

### 3. æ›´æ–°æµ‹è¯• Mock

**æ–‡ä»¶**: 
- `src/utils/IconComposer.test.ts`
- `src/utils/IconManager.test.ts`

**ä¿®æ”¹å†…å®¹**: 
åœ¨ `MockCanvasRenderingContext2D` ä¸­æ·»åŠ æ–‡æœ¬ç»˜åˆ¶ç›¸å…³æ–¹æ³•ï¼š
```typescript
class MockCanvasRenderingContext2D {
  // ... å·²æœ‰å±æ€§
  strokeStyle = '#000000'
  lineWidth = 1
  font = '10px sans-serif'
  textAlign = 'start'
  textBaseline = 'alphabetic'
  
  // ... å·²æœ‰æ–¹æ³•
  fillText() {}
  stroke() {}
}
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•
```bash
âœ“ src/utils/IconComposer.test.ts (25 tests)
âœ“ src/utils/IconManager.test.ts (23 tests)
```

### çŠ¶æ€ä¼˜å…ˆçº§éªŒè¯

| å­¦ä¹ è¿›åº¦ | æ¨èæ•° | é¢„æœŸçŠ¶æ€ | å®é™…çŠ¶æ€ | âœ… |
|---------|-------|---------|---------|---|
| 0 é¡µ    | 0     | å­¦ä¹ è¿›åº¦ï¼ˆå…¨é®ç½©ï¼‰ | âœ… | âœ… |
| 50 é¡µ   | 0     | å­¦ä¹ è¿›åº¦ï¼ˆåŠé®ç½©ï¼‰ | âœ… | âœ… |
| 99 é¡µ   | 3     | å­¦ä¹ è¿›åº¦ï¼ˆå‡ ä¹æ— é®ç½©ï¼‰ | âœ… | âœ… |
| 100 é¡µ  | 0     | é™æ€ï¼ˆæ— é®ç½©ï¼‰ | âœ… | âœ… |
| 100 é¡µ  | 1     | æ¨èï¼ˆ1æ³¢çº¹+æ•°å­—1ï¼‰ | âœ… | âœ… |
| 100 é¡µ  | 3     | æ¨èï¼ˆ3æ³¢çº¹+æ•°å­—3ï¼‰ | âœ… | âœ… |

### è§†è§‰æ•ˆæœé¢„æœŸ

**å­¦ä¹ é˜¶æ®µï¼ˆ<100é¡µï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚  â† é»‘è‰²åŠé€æ˜é®ç½©ï¼ˆä»ä¸Šå¾€ä¸‹ï¼‰
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚     é®ç½©é«˜åº¦ = (1 - è¿›åº¦%) Ã— 100%
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“   â”‚
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   â”‚  â† æ©™è‰²å›¾æ ‡é€æ¸éœ²å‡º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¨èé˜¶æ®µï¼ˆâ‰¥100é¡µï¼Œæœ‰æ¨èï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â—‹ â—‹ â—‹      â”‚  â† 1-3æ¡æ³¢çº¹ç‚¹äº®
â”‚    â—        â”‚
â”‚            â“·â”‚  â† å³ä¸‹è§’æ¨èæ•°å­—ï¼ˆæ©™è‰²åœ†å½¢+ç™½è‰²æ•°å­—ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¨èé˜¶æ®µï¼ˆâ‰¥100é¡µï¼Œæ— æ¨èï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â—‹ â—‹ â—‹      â”‚  â† 3æ¡ç°ç™½æ³¢çº¹ï¼ˆæœªç‚¹äº®ï¼‰
â”‚    â—        â”‚  â† ç™½è‰²åœ†ç‚¹
â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ è®¾è®¡ç»†èŠ‚

### æ¨èæ•°å­—å¾½ç« 
- **é¢œè‰²**: ä¸»é¢˜æ©™è‰² `#FF6B00` (90% ä¸é€æ˜)
- **å­—ä½“**: ç³»ç»Ÿé»˜è®¤ï¼ŒåŠ ç²—
- **å¤§å°**: 
  - å¾½ç« ç›´å¾„: å›¾æ ‡å®½åº¦ Ã— 0.35 (128px â†’ 44.8px)
  - å­—ä½“å¤§å°: å¾½ç« ç›´å¾„ Ã— 0.65 (44.8px â†’ 29.12px)
  - è¾¹è·: å›¾æ ‡å®½åº¦ Ã— 0.05 (128px â†’ 6.4px)
- **æè¾¹**: ç™½è‰² 30% ä¸é€æ˜ï¼Œå®½åº¦ 1.92px
- **å¯¹æ¯”åº¦**: ç™½è‰²æ–‡å­—åœ¨æ©™è‰²èƒŒæ™¯ä¸Šï¼ŒWCAG AAA çº§

### Canvas ç»˜åˆ¶ä¼˜åŠ¿
ç›¸æ¯” Chrome Badge APIï¼š
- âœ… **æ ·å¼å¯æ§**: å¯è‡ªå®šä¹‰èƒŒæ™¯è‰²ã€é€æ˜åº¦ã€æè¾¹
- âœ… **ä½ç½®çµæ´»**: å¯ç²¾ç¡®æ§åˆ¶ä½ç½®ï¼ˆå³ä¸‹è§’ï¼‰
- âœ… **å­—ä½“å¤§å°**: å¯æ ¹æ®å›¾æ ‡å¤§å°è‡ªé€‚åº”
- âœ… **è§†è§‰ç»Ÿä¸€**: ä¸å›¾æ ‡ä¸»é¢˜è‰²ä¿æŒä¸€è‡´
- âŒ **åŠ£åŠ¿**: éœ€è¦æ‰‹åŠ¨ç»˜åˆ¶ï¼Œä»£ç æ›´å¤æ‚

## ğŸ“ çŠ¶æ€ä¼˜å…ˆçº§æ€»ç»“

æ›´æ–°åçš„ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
```
1. é”™è¯¯ (hasError: true)
   â””â”€ æ•´ä¸ªå›¾æ ‡çº¢è‰²é—ªåŠ¨

2. RSS å‘ç°åŠ¨ç”» (discover)
   â””â”€ 0â†’1â†’2â†’3æ¡æ³¢çº¹å¾ªç¯ï¼Œ6ç§’ååœæ­¢

3. æš‚åœ (paused)
   â””â”€ å›¾æ ‡ç°åº¦æ»¤é•œ

4. åå°æŠ“å– (fetching)
   â””â”€ 3æ¡æ³¢çº¹å‘¼å¸åŠ¨ç”»

5. å­¦ä¹ è¿›åº¦ (learning, ä»… <100é¡µ)  â† å…³é”®ä¿®æ”¹
   â””â”€ é»‘è‰²é®ç½©ä»ä¸Šå¾€ä¸‹é®è”½

6. æ¨èé˜…è¯» (recommend, å­¦ä¹ å®Œæˆå)  â† å…³é”®ä¿®æ”¹
   â””â”€ 1-3æ¡æ³¢çº¹ç‚¹äº® + å³ä¸‹è§’æ•°å­—

7. é™æ€ (static, å­¦ä¹ å®Œæˆä¸”æ— æ¨è)
   â””â”€ ç°ç™½æ³¢çº¹ + ç™½è‰²åœ†ç‚¹
```

## ğŸ”„ å½±å“èŒƒå›´

### ä¿®æ”¹æ–‡ä»¶
1. `src/utils/IconManager.ts` - ä¼˜å…ˆçº§é€»è¾‘ä¿®æ­£
2. `src/utils/IconComposer.ts` - æ–°å¢æ¨èæ•°å­—ç»˜åˆ¶
3. `src/utils/IconComposer.test.ts` - æ›´æ–° Canvas mock
4. `src/utils/IconManager.test.ts` - æ›´æ–° Canvas mock

### å‘åå…¼å®¹æ€§
- âœ… **API å…¼å®¹**: æ¥å£æœªå˜æ›´
- âœ… **æ•°æ®å…¼å®¹**: ä¸å½±å“å­˜å‚¨æ•°æ®
- âœ… **æµ‹è¯•å…¼å®¹**: æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… **è§†è§‰æ¸è¿›**: æ—§ç‰ˆæœ¬ç”¨æˆ·ä¸ä¼šçœ‹åˆ°å¼‚å¸¸

## ğŸš€ éƒ¨ç½²å»ºè®®

### æµè§ˆå™¨æµ‹è¯•
1. **å†·å¯åŠ¨æµ‹è¯•**ï¼ˆ<100é¡µï¼‰
   - æ¸…ç©ºæ•°æ®ï¼Œé‡æ–°åŠ è½½æ‰©å±•
   - æµè§ˆ 0/50/99 é¡µï¼ŒéªŒè¯å­¦ä¹ è¿›åº¦é®ç½©æ­£ç¡®æ˜¾ç¤º
   - âœ… åº”çœ‹åˆ°é»‘è‰²é®ç½©ä»ä¸Šå¾€ä¸‹é€æ¸å‡å°‘

2. **å­¦ä¹ å®Œæˆæµ‹è¯•**ï¼ˆâ‰¥100é¡µï¼‰
   - æµè§ˆè‡³ 100 é¡µ
   - éªŒè¯å­¦ä¹ è¿›åº¦é®ç½©æ¶ˆå¤±
   - âœ… åº”çœ‹åˆ°å®Œæ•´çš„æ©™è‰²å›¾æ ‡ï¼ˆæ— é®ç½©ï¼‰

3. **æ¨èçŠ¶æ€æµ‹è¯•**
   - è®¢é˜… RSS æºï¼Œç”Ÿæˆ 1-3 æ¡æ¨è
   - éªŒè¯æ³¢çº¹ç‚¹äº® + å³ä¸‹è§’æ•°å­—æ˜¾ç¤º
   - âœ… åº”çœ‹åˆ°æ©™è‰²åœ†å½¢å¾½ç« æ˜¾ç¤ºæ•°å­— 1/2/3

4. **RSS å‘ç°æµ‹è¯•**
   - è§¦å‘ RSS è‡ªåŠ¨å‘ç°
   - éªŒè¯å‘ç°åŠ¨ç”»ä¼˜å…ˆçº§é«˜äºæ¨è
   - âœ… åº”çœ‹åˆ°æ³¢çº¹åŠ¨ç”»ï¼Œæ•°å­—å¾½ç« ä»ç„¶æ˜¾ç¤º

5. **çŠ¶æ€åˆ‡æ¢æµ‹è¯•**
   - RSS å‘ç°åŠ¨ç”»ç»“æŸå
   - éªŒè¯å›¾æ ‡æ¢å¤åˆ°æ¨èçŠ¶æ€ï¼ˆæ³¢çº¹+æ•°å­—ï¼‰
   - âœ… ä¸åº”è¯¥å‡ºç°å­¦ä¹ è¿›åº¦é®ç½©

### å›å½’æµ‹è¯•
```bash
npm run test:run
npm run build
```

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [PRD.md](./PRD.md) - äº§å“éœ€æ±‚
- [TDD.md](./TDD.md) - æŠ€æœ¯è®¾è®¡
- [PHASE_5_RSS_DISCOVERY.md](./PHASE_5_RSS_DISCOVERY.md) - RSS å‘ç°åŠŸèƒ½
- [PHASE_7_DB_OPTIMIZATION.md](./PHASE_7_DB_OPTIMIZATION.md) - æ•°æ®åº“ä¼˜åŒ–

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. **ä¿®æ­£ä¼˜å…ˆçº§**ï¼šç¡®ä¿æ¨èé˜¶æ®µä¸æ˜¾ç¤ºå­¦ä¹ è¿›åº¦é®ç½©
2. **å¢å¼ºå¯è§æ€§**ï¼šæ¨èæ•°å­—æ›´åŠ é†’ç›®ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

æ ¸å¿ƒåŸåˆ™ï¼š
- **é˜¶æ®µæ˜ç¡®**ï¼šå­¦ä¹ é˜¶æ®µæ˜¾ç¤ºè¿›åº¦ï¼Œæ¨èé˜¶æ®µæ˜¾ç¤ºæ¨è
- **ä¼˜å…ˆçº§æ¸…æ™°**ï¼šå­¦ä¹ è¿›åº¦åˆ¤æ–­å¿…é¡»æ£€æŸ¥æ˜¯å¦åœ¨å­¦ä¹ é˜¶æ®µ
- **è§†è§‰ç»Ÿä¸€**ï¼šæ¨èæ•°å­—å¾½ç« ä½¿ç”¨ä¸»é¢˜æ©™è‰²ï¼Œä¸å›¾æ ‡é£æ ¼ä¸€è‡´

çŠ¶æ€æœºé€»è¾‘æ›´åŠ å¥å£®ï¼Œç”¨æˆ·ä½“éªŒæ›´åŠ æµç•…ï¼ğŸ‰

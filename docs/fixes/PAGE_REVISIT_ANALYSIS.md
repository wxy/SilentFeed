# é¡µé¢é‡å¤å­¦ä¹ é—®é¢˜åˆ†æ

## é—®é¢˜æè¿°

ç”¨æˆ·å‘ç°ç³»ç»Ÿä¼šé‡å¤å­¦ä¹ åŒä¸€ä¸ªé¡µé¢ï¼Œå¯¼è‡´æ•°æ®åº“ä¸­å‡ºç°åŒä¸€ URL çš„å¤šæ¡è®¿é—®è®°å½•ã€‚

## å½“å‰æœºåˆ¶åˆ†æ

### 1. Content Script å±‚é¢ï¼ˆpage-tracker.tsï¼‰

**å»é‡æœºåˆ¶**ï¼š
- ä½¿ç”¨ `isRecorded` æ ‡å¿—é˜²æ­¢å•æ¬¡é¡µé¢ä¼šè¯ä¸­é‡å¤è®°å½•
- é—®é¢˜ï¼šæ¯æ¬¡é¡µé¢åˆ·æ–°æˆ–é‡æ–°è®¿é—®æ—¶ï¼Œ`isRecorded` ä¼šè¢«é‡ç½®ä¸º `false`

```typescript
// src/contents/page-tracker.ts:467
if (isRecorded) {
  logger.debug('ğŸš« [PageTracker] å·²è®°å½•è¿‡ï¼Œè·³è¿‡')
  return
}
```

**SPA å¤„ç†**ï¼š
- ç›‘å¬ URL å˜åŒ–ï¼ˆ`popstate`ã€`pushstate`ã€`replacestate`ï¼‰
- URL å˜åŒ–æ—¶ä¼šé‡ç½®è¿½è¸ªçŠ¶æ€
- è¿™æ„å‘³ç€åœ¨åŒä¸€ä¸ªç½‘ç«™å†…å¯¼èˆªä¼šè¢«è§†ä¸ºä¸åŒçš„è®¿é—®

### 2. Background å±‚é¢ï¼ˆbackground.tsï¼‰

**ä¿å­˜é€»è¾‘**ï¼š
```typescript
// src/background.ts:377
await db.confirmedVisits.add(visitData)
```

- ç›´æ¥ä½¿ç”¨ `add()` æ–¹æ³•æ·»åŠ è®°å½•
- **æ²¡æœ‰ä»»ä½• URL å»é‡æ£€æŸ¥**
- æ¯æ¬¡æ¥æ”¶åˆ° `SAVE_PAGE_VISIT` æ¶ˆæ¯éƒ½ä¼šæ–°å¢ä¸€æ¡è®°å½•

### 3. SemanticProfileBuilder å±‚é¢

**å»é‡æœºåˆ¶**ï¼š
```typescript
// src/core/profile/SemanticProfileBuilder.ts:174-179
// å»é‡æ£€æŸ¥ï¼š5åˆ†é’Ÿå†…ç›¸åŒ URL åªå¤„ç†ä¸€æ¬¡
const lastBrowseTime = this.recentBrowses.get(page.url)
if (lastBrowseTime && (now - lastBrowseTime) < this.BROWSE_DEDUP_MS) {
  return
}
```

- ä»…åœ¨ç”»åƒå­¦ä¹ å±‚é¢å»é‡ï¼ˆ5åˆ†é’Ÿçª—å£ï¼‰
- **ä¸å½±å“æ•°æ®åº“è®°å½•**ï¼šé¡µé¢ä»ç„¶è¢«ä¿å­˜åˆ° `confirmedVisits`

### 4. æ•°æ®åº“è®¾è®¡ï¼ˆdb/index.tsï¼‰

**ç´¢å¼•è®¾è®¡**ï¼š
```typescript
confirmedVisits: 'id, domain, visitTime, *analysis.keywords, [visitTime+domain]'
```

- ä¸»é”®æ˜¯ `id`ï¼ˆUUIDï¼‰ï¼Œæ¯æ¬¡éƒ½æ˜¯å”¯ä¸€çš„
- **æ²¡æœ‰ URL å”¯ä¸€æ€§çº¦æŸ**
- å¤åˆç´¢å¼• `[visitTime+domain]` å…è®¸åŒä¸€åŸŸåå¤šæ¬¡è®¿é—®

## é—®é¢˜æ ¹æº

1. **æ•°æ®åº“å±‚é¢**ï¼š`confirmedVisits` è¡¨æ²¡æœ‰ URL å”¯ä¸€æ€§çº¦æŸ
2. **ä¿å­˜é€»è¾‘**ï¼šBackground ç›´æ¥ `add()` è€Œä¸æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
3. **è®¾è®¡æ„å›¾**ï¼šç³»ç»Ÿè®¾è®¡ä¸Š**å…è®¸**é‡å¤è®¿é—®åŒä¸€ä¸ª URL

## ä¸šåŠ¡åœºæ™¯åˆ†æ

### åœºæ™¯ 1ï¼šç”¨æˆ·å¤šæ¬¡è®¿é—®åŒä¸€æ–‡ç« ï¼ˆå†…å®¹æœªå˜åŒ–ï¼‰

**ç°çŠ¶**ï¼š
- æ¯æ¬¡è®¿é—®éƒ½ä¼šåˆ›å»ºæ–°çš„ `ConfirmedVisit` è®°å½•
- ç”»åƒå­¦ä¹ ä¼šè¢« 5 åˆ†é’Ÿå»é‡çª—å£é™åˆ¶

**é—®é¢˜**ï¼š
- æ•°æ®åº“å†—ä½™ï¼ˆåŒä¸€å†…å®¹è¢«å¤šæ¬¡è®°å½•ï¼‰
- ç»Ÿè®¡ä¸å‡†ç¡®ï¼ˆé¡µé¢è®¿é—®æ•°è¢«å¤¸å¤§ï¼‰

**åˆç†æ€§**ï¼š
- âŒ ä¸åˆç†ï¼šæµªè´¹å­˜å‚¨ç©ºé—´
- âŒ å¯èƒ½å¹²æ‰°æ¨èç®—æ³•ï¼ˆé‡å¤çš„å…´è¶£ä¿¡å·ï¼‰

### åœºæ™¯ 2ï¼šç”¨æˆ·å¤šæ¬¡è®¿é—®åŒä¸€ URLï¼ˆå†…å®¹å·²æ›´æ–°ï¼‰

**ç°çŠ¶**ï¼š
- åŒæ ·ä¼šåˆ›å»ºå¤šæ¡è®°å½•
- æ¯æ¡è®°å½•çš„ `analysis` å¯èƒ½ä¸åŒï¼ˆå¦‚æœå†…å®¹å˜åŒ–äº†ï¼‰

**åˆç†æ€§**ï¼š
- âœ… åˆç†ï¼šè®°å½•ç”¨æˆ·å…´è¶£å˜åŒ–
- âœ… åˆç†ï¼šæ•æ‰å†…å®¹æ›´æ–°åçš„å†æ¬¡å…³æ³¨

**ä¾‹å­**ï¼š
- æ–°é—»ç½‘ç«™ï¼šåŒä¸€ URL ä½†æ ‡é¢˜/å†…å®¹æ›´æ–°
- GitHub Issueï¼šæŒç»­å…³æ³¨æŸä¸ª Issue çš„è¿›å±•
- åšå®¢æ–‡ç« ï¼šä½œè€…æ›´æ–°äº†å†…å®¹

### åœºæ™¯ 3ï¼šçŸ­æ—¶é—´å†…é‡å¤è®¿é—®ï¼ˆä¾‹å¦‚åˆ·æ–°é¡µé¢ï¼‰

**ç°çŠ¶**ï¼š
- å¦‚æœè¶…è¿‡ 30 ç§’é˜ˆå€¼ï¼Œä¼šè¢«è®°å½•ä¸¤æ¬¡
- ç”»åƒå­¦ä¹ æœ‰ 5 åˆ†é’Ÿå»é‡ä¿æŠ¤

**é—®é¢˜**ï¼š
- âŒ ä¸åˆç†ï¼šæ˜æ˜¾çš„è¯¯è®°å½•

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šä¸¥æ ¼å»é‡ï¼ˆä¸æ¨èï¼‰

**å®ç°**ï¼š
- åœ¨ Background ä¿å­˜å‰æ£€æŸ¥ URL æ˜¯å¦å·²å­˜åœ¨
- å¦‚æœå­˜åœ¨ï¼Œæ›´æ–° `visitTime` å’Œ `duration`

**ä¼˜ç‚¹**ï¼š
- æ•°æ®åº“å¹²å‡€ï¼Œæ— å†—ä½™

**ç¼ºç‚¹**ï¼š
- âŒ ä¸¢å¤±è®¿é—®å†å²ï¼ˆæ— æ³•çŸ¥é“ç”¨æˆ·è®¿é—®äº†å‡ æ¬¡ï¼‰
- âŒ æ— æ³•è¿½è¸ªå†…å®¹æ›´æ–°åçš„å†æ¬¡å…³æ³¨
- âŒ ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼ˆæœ€åä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œè€Œéæ‰€æœ‰è®¿é—®ï¼‰

### æ–¹æ¡ˆ Bï¼šæ—¶é—´çª—å£å»é‡ï¼ˆæ¨èï¼‰â­

**å®ç°**ï¼š
- åœ¨æ•°æ®åº“ä¿å­˜å‰æ£€æŸ¥ï¼š
  - åŒä¸€ URL
  - æœ€è¿‘ N åˆ†é’Ÿå†…ï¼ˆå»ºè®® 30 åˆ†é’Ÿï¼‰
- å¦‚æœæ‰¾åˆ°ï¼Œæ›´æ–°ç°æœ‰è®°å½•çš„ `visitTime` å’Œ `duration`
- å¦‚æœæ²¡æœ‰æˆ–è¶…è¿‡æ—¶é—´çª—å£ï¼Œåˆ›å»ºæ–°è®°å½•

**ä¼˜ç‚¹**ï¼š
- âœ… å¹³è¡¡äº†å»é‡å’Œå†å²è¿½è¸ª
- âœ… ä¿ç•™é•¿æœŸè®¿é—®å†å²
- âœ… å‡å°‘çŸ­æœŸé‡å¤è®°å½•
- âœ… ç¬¦åˆç”¨æˆ·é¢„æœŸï¼ˆ30 åˆ†é’Ÿå†…çš„å¤šæ¬¡è®¿é—®ç®—ä¸€æ¬¡ï¼‰

**å®ç°ç¤ºä¾‹**ï¼š
```typescript
// src/background.ts
case 'SAVE_PAGE_VISIT':
  const visitData = message.data
  
  // æ£€æŸ¥æœ€è¿‘ 30 åˆ†é’Ÿå†…æ˜¯å¦æœ‰ç›¸åŒ URL çš„è®¿é—®
  const thirtyMinutesAgo = Date.now() - 30 * 60 * 1000
  const recentVisit = await db.confirmedVisits
    .where('url').equals(visitData.url)
    .and(visit => visit.visitTime > thirtyMinutesAgo)
    .first()
  
  if (recentVisit) {
    // æ›´æ–°ç°æœ‰è®°å½•
    await db.confirmedVisits.update(recentVisit.id, {
      visitTime: visitData.visitTime,
      duration: recentVisit.duration + visitData.duration,
      interactionCount: recentVisit.interactionCount + visitData.interactionCount
    })
  } else {
    // åˆ›å»ºæ–°è®°å½•
    await db.confirmedVisits.add(visitData)
  }
```

### æ–¹æ¡ˆ Cï¼šè½¯å»é‡ + å…³è”è®°å½•ï¼ˆå¤æ‚ä½†æœ€å®Œæ•´ï¼‰

**å®ç°**ï¼š
- æ·»åŠ  `originalVisitId` å­—æ®µ
- é¦–æ¬¡è®¿é—®åˆ›å»ºä¸»è®°å½•
- åç»­è®¿é—®åˆ›å»ºå­è®°å½•å¹¶å…³è”åˆ°ä¸»è®°å½•
- ç»Ÿè®¡æ—¶å¯ä»¥é€‰æ‹©æ˜¯å¦åŒ…å«å­è®°å½•

**ä¼˜ç‚¹**ï¼š
- âœ… ä¿ç•™å®Œæ•´è®¿é—®å†å²
- âœ… æ”¯æŒçµæ´»çš„ç»Ÿè®¡ç­–ç•¥

**ç¼ºç‚¹**ï¼š
- âŒ å®ç°å¤æ‚
- âŒ æŸ¥è¯¢æ€§èƒ½å½±å“

### æ–¹æ¡ˆ Dï¼šé…ç½®åŒ–ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰

**å®ç°**ï¼š
- æ·»åŠ ç”¨æˆ·è®¾ç½®ï¼š
  - `deduplication: 'none' | 'strict' | 'window'`
  - `deduplicationWindow: number`ï¼ˆåˆ†é’Ÿï¼‰
- æ ¹æ®ç”¨æˆ·é€‰æ‹©åº”ç”¨ä¸åŒç­–ç•¥

**ä¼˜ç‚¹**ï¼š
- âœ… çµæ´»æ€§é«˜
- âœ… æ»¡è¶³ä¸åŒç”¨æˆ·éœ€æ±‚

**ç¼ºç‚¹**ï¼š
- âŒ å¢åŠ å¤æ‚åº¦
- âŒ ç”¨æˆ·å¯èƒ½ä¸ç†è§£è¿™äº›é€‰é¡¹

## æ¨èæ–¹æ¡ˆ

**é‡‡ç”¨æ–¹æ¡ˆ Bï¼ˆæ—¶é—´çª—å£å»é‡ï¼‰**ï¼Œé…ç½®å¦‚ä¸‹ï¼š

1. **å»é‡çª—å£**ï¼š30 åˆ†é’Ÿ
   - ç†ç”±ï¼šä¸ Content Script çš„ 30 ç§’é˜ˆå€¼å¯¹åº”ï¼Œåˆç†çš„çŸ­æœŸå»é‡æœŸ
   - ç”¨æˆ·åœ¨ 30 åˆ†é’Ÿå†…åå¤è®¿é—®åŒä¸€é¡µé¢ï¼Œè§†ä¸ºåŒä¸€æ¬¡å­¦ä¹ ä¼šè¯

2. **æ›´æ–°ç­–ç•¥**ï¼š
   - æ›´æ–° `visitTime` ä¸ºæœ€æ–°æ—¶é—´
   - ç´¯åŠ  `duration`ï¼ˆæ€»åœç•™æ—¶é—´ï¼‰
   - ç´¯åŠ  `interactionCount`
   - ä¿ç•™åŸæœ‰çš„ `analysis`ï¼ˆå‡è®¾å†…å®¹æœªå˜åŒ–ï¼‰

3. **ç‰¹æ®Šæƒ…å†µ**ï¼š
   - å¦‚æœ `analysis` å†…å®¹å‘ç”Ÿé‡å¤§å˜åŒ–ï¼ˆä¾‹å¦‚å…³é”®è¯å®Œå…¨ä¸åŒï¼‰ï¼Œè§†ä¸ºæ–°å†…å®¹ï¼Œåˆ›å»ºæ–°è®°å½•
   - è¿™éœ€è¦å†…å®¹å“ˆå¸Œæˆ–å…³é”®è¯ç›¸ä¼¼åº¦æ£€æµ‹

## å®ç°æ­¥éª¤

1. âœ… åˆ›å»ºåˆ†æ”¯ `feature/page-revisit-handling`
2. â¬œ æ·»åŠ  URL ç´¢å¼•åˆ° `confirmedVisits` è¡¨
3. â¬œ å®ç°æ—¶é—´çª—å£å»é‡é€»è¾‘
4. â¬œ æ·»åŠ æ—¥å¿—è®°å½•å»é‡è¡Œä¸º
5. â¬œ ç¼–å†™æµ‹è¯•ç”¨ä¾‹
6. â¬œ æ›´æ–°æ–‡æ¡£

## æµ‹è¯•åœºæ™¯

1. **åŒä¸€é¡µé¢å¤šæ¬¡è®¿é—®**ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
   - é¢„æœŸï¼šåªæœ‰ä¸€æ¡è®°å½•ï¼Œduration ç´¯åŠ 

2. **åŒä¸€é¡µé¢å¤šæ¬¡è®¿é—®**ï¼ˆ30åˆ†é’Ÿåï¼‰
   - é¢„æœŸï¼šåˆ›å»ºæ–°è®°å½•

3. **ä¸åŒé¡µé¢è®¿é—®**
   - é¢„æœŸï¼šæ­£å¸¸åˆ›å»ºå¤šæ¡è®°å½•

4. **é¡µé¢åˆ·æ–°**ï¼ˆå¿«é€Ÿåˆ·æ–°ï¼‰
   - é¢„æœŸï¼šå¦‚æœè¶…è¿‡30ç§’é˜ˆå€¼ï¼Œåº”è¯¥è¢«å»é‡

5. **SPA å¯¼èˆª**ï¼ˆç«™å†…è·³è½¬ï¼‰
   - é¢„æœŸï¼šä¸åŒ URLï¼Œåº”è¯¥åˆ›å»ºä¸åŒè®°å½•

## é…ç½®é€‰é¡¹ï¼ˆæœªæ¥æ‰©å±•ï¼‰

å¯ä»¥è€ƒè™‘æ·»åŠ åˆ° Settingsï¼š

```typescript
interface TrackingSettings {
  // é¡µé¢è®¿é—®å»é‡ç­–ç•¥
  visitDeduplication: {
    enabled: boolean           // æ˜¯å¦å¯ç”¨å»é‡
    windowMinutes: number      // å»é‡æ—¶é—´çª—å£ï¼ˆåˆ†é’Ÿï¼‰
    mergeContent: boolean      // æ˜¯å¦åˆå¹¶å†…å®¹åˆ†æç»“æœ
  }
}
```

## ç›¸å…³ä»£ç 

- `src/contents/page-tracker.ts:467-500` - è®°å½•é¡µé¢è®¿é—®
- `src/background.ts:300-420` - ä¿å­˜è®¿é—®è®°å½•
- `src/core/profile/SemanticProfileBuilder.ts:167-215` - ç”»åƒå­¦ä¹ å»é‡
- `src/storage/db/index.ts:80-200` - æ•°æ®åº“ç´¢å¼•å®šä¹‰

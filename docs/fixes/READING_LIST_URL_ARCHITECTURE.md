# é˜…è¯»æ¸…å• URL ç®¡ç†æ¶æ„åˆ†æ

## æ–‡æ¡£ç›®æ ‡

æœ¬æ–‡æ¡£æ—¨åœ¨å…¨é¢åˆ†ææ¨èç³»ç»Ÿä¸­ URL çš„ç”Ÿå‘½å‘¨æœŸå’Œå†³ç­–æœºåˆ¶ï¼Œè¯†åˆ«å½“å‰æ¶æ„ä¸­çš„é—®é¢˜ç‚¹ï¼Œå¹¶æå‡ºç»Ÿä¸€çš„è§£å†³æ–¹æ¡ˆã€‚

## é—®é¢˜æè¿°

### ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜

1. **æ¨¡å¼åˆ‡æ¢æ—¶ URL ç±»å‹æ··ä¹±**
   - ä»å¼¹çª—æ¨¡å¼åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼æ—¶
   - åº”ä½¿ç”¨ç¿»è¯‘é“¾æ¥çš„æ¨èåè€Œä½¿ç”¨äº†åŸæ–‡é“¾æ¥
   - ä¸åº”ä½¿ç”¨ç¿»è¯‘é“¾æ¥çš„æ¨èåè€Œä½¿ç”¨äº†ç¿»è¯‘é“¾æ¥

2. **æ¨èæ¡ç›®æ¶ˆå¤±**
   - å†æ¬¡ä»é˜…è¯»æ¸…å•æ¨¡å¼åˆ‡æ¢å›å¼¹çª—æ¨¡å¼æ—¶
   - ä¹‹å‰è½¬ç§»çš„æ¨èæ¡ç›®æ¶ˆå¤±

3. **é—®é¢˜åå¤å‡ºç°**
   - è¯¥é—®é¢˜å·²å¤šæ¬¡ä¿®å¤ä½†ä»ç„¶å¤ç°
   - è¯´æ˜è§£å†³æ–¹æ¡ˆä¸å¤Ÿç³»ç»ŸåŒ–ï¼Œå­˜åœ¨æ¶æ„å±‚é¢çš„ç¼ºé™·

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ¨èç³»ç»Ÿæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ RecommendationService â”‚  â”‚  ReadingListManager â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                          â”‚                          â”‚
â”‚         â”‚ ç”Ÿæˆæ¨è                  â”‚ ç®¡ç†é˜…è¯»æ¸…å•             â”‚
â”‚         â–¼                          â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚          æ¨èæ•°æ®åº“ (Recommendation)      â”‚                â”‚
â”‚  â”‚  - url: string                           â”‚                â”‚
â”‚  â”‚  - translation?: TranslationData         â”‚                â”‚
â”‚  â”‚  - sourceUrl?: string                    â”‚                â”‚
â”‚  â”‚  - savedToReadingList: boolean          â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                      â”‚                                        â”‚
â”‚                      â”‚ æ¨¡å¼åˆ‡æ¢                               â”‚
â”‚                      â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚         background.ts                    â”‚                â”‚
â”‚  â”‚   DELIVERY_MODE_CHANGED å¤„ç†å™¨            â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                          â”‚                          â”‚
â”‚         â–¼                          â–¼                          â”‚
â”‚  [å¼¹çª—æ¨¡å¼]                  [é˜…è¯»æ¸…å•æ¨¡å¼]                    â”‚
â”‚  Popup å±•ç¤º                Chrome Reading List               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸¤ç§æŠ•é€’æ¨¡å¼

#### å¼¹çª—æ¨¡å¼ (popup)
- æ¨èå­˜å‚¨åœ¨ `recommendations` è¡¨
- ç”¨æˆ·é€šè¿‡æ‰©å±•å¼¹çª—æŸ¥çœ‹
- æ”¯æŒå¿«é€Ÿæ“ä½œï¼ˆå·²è¯»ã€ç¨åè¯»ã€ä¸æ„Ÿå…´è¶£ï¼‰

#### é˜…è¯»æ¸…å•æ¨¡å¼ (readingList)  
- æ¨èè‡ªåŠ¨ä¿å­˜åˆ° Chrome åŸç”Ÿé˜…è¯»æ¸…å•
- ç”¨æˆ·é€šè¿‡æµè§ˆå™¨é˜…è¯»æ¸…å•æŸ¥çœ‹
- æ‰©å±•è®°å½•å…³è”å…³ç³»åˆ° `readingListEntries` è¡¨

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šURL çš„ç”Ÿå‘½å‘¨æœŸ

### 2.1 æ¨èç”Ÿæˆé˜¶æ®µ

**å…¥å£**: `RecommendationService.generateRecommendations()`

```typescript
// 1. æ”¶é›†æ–‡ç« ï¼ˆä» feedArticles è¡¨ï¼‰
const articles = await this.collectArticles(sources, batchSize)

// 2. æ¨èç®¡é“å¤„ç†
const result = await this.pipeline.process(inputs, profile, config)

// 3. ä¿å­˜æ¨èåˆ°æ•°æ®åº“
const recommendations = await this.saveRecommendations(highQualityArticles, config)
```

**å…³é”®ç‚¹**:
- æ­¤æ—¶æ¨èçš„ `url` å­—æ®µå­˜å‚¨çš„æ˜¯**æ–‡ç« çš„åŸå§‹ URL**ï¼ˆæ¥è‡ª RSS feedï¼‰
- ä½¿ç”¨ `normalizeUrlForTracking()` è¿›è¡Œå»é‡

```typescript
// src/core/recommender/RecommendationService.ts:830
const recommendation: Recommendation = {
  id: `rec-${now}-${index}`,
  url: normalizedArticleUrl,  // â† è§„èŒƒåŒ–åçš„åŸå§‹URL
  title: article.title,
  summary: article.aiAnalysis?.summary || ...,
  sourceUrl: feedUrl,  // RSS æº URL
  translation: article.aiAnalysis?.translatedTitle ? {
    sourceLanguage: ...,
    targetLanguage: ...,
    translatedTitle: article.aiAnalysis.translatedTitle,
    ...
  } : undefined
}
```

**å­˜å‚¨çŠ¶æ€**:
- `recommendations.url`: åŸå§‹æ–‡ç«  URLï¼ˆè§„èŒƒåŒ–åï¼‰
- `recommendations.translation`: å¦‚æœ AI æä¾›äº†ç¿»è¯‘ï¼ŒåŒ…å«ç¿»è¯‘æ•°æ®
- `recommendations.sourceUrl`: æ‰€å± RSS æº

### 2.2 è‡ªåŠ¨ç¿»è¯‘é˜¶æ®µ

**å…¥å£**: `translateRecommendations()` ï¼ˆå¦‚æœ `autoTranslate` å¯ç”¨ï¼‰

```typescript
// src/core/recommender/RecommendationService.ts:518
if (uiConfig.autoTranslate && recommendations.length > 0) {
  const translatedRecs = await translateRecommendations(recommendations)
  recommendations.splice(0, recommendations.length, ...translatedRecs)
}
```

**å…³é”®ç‚¹**:
- ä¸ºæ²¡æœ‰ `translation` å­—æ®µçš„æ¨èè¡¥å……ç¿»è¯‘
- **ä¸ä¿®æ”¹** `url` å­—æ®µï¼ˆä»ç„¶æ˜¯åŸå§‹ URLï¼‰
- åªæ›´æ–° `translation` å­—æ®µ

**å­˜å‚¨çŠ¶æ€**:
- `recommendations.url`: **ä»ç„¶æ˜¯åŸå§‹ URL**
- `recommendations.translation`: è¡¥å……å®Œæ•´çš„ç¿»è¯‘æ•°æ®

### 2.3 æŠ•é€’é˜¶æ®µ

#### 2.3.1 é˜…è¯»æ¸…å•æ¨¡å¼æŠ•é€’

**å…¥å£**: `RecommendationService.generateRecommendations()` â†’ é˜…è¯»æ¸…å•åˆ†æ”¯

```typescript
// src/core/recommender/RecommendationService.ts:534
if (deliveryMode === 'readingList' && ReadingListManager.isAvailable()) {
  for (const rec of recommendations) {
    await ReadingListManager.saveRecommendation(
      rec,
      uiConfig.autoTranslate,     // â† è‡ªåŠ¨ç¿»è¯‘å¼€å…³
      interfaceLanguage,          // â† ç•Œé¢è¯­è¨€
      titlePrefix                 // â† æ ‡é¢˜å‰ç¼€
    )
  }
}
```

**`ReadingListManager.saveRecommendation()` å¤„ç†æµç¨‹**:

```typescript
// src/core/reading-list/reading-list-manager.ts:203
// 1. æŸ¥è¯¢è®¢é˜…æºçš„ç¿»è¯‘è®¾ç½®
let feedUseGoogleTranslate = true
if (recommendation.sourceUrl) {
  const feed = await feedManager.getFeedByUrl(recommendation.sourceUrl)
  if (feed) {
    feedUseGoogleTranslate = feed.useGoogleTranslate !== false
  }
}

// 2. è°ƒç”¨ URL å†³ç­–å‡½æ•°
const { url, title } = await ReadingListManager.decideRecommendationUrl(
  recommendation,
  autoTranslateEnabled,      // â† å…¨å±€è‡ªåŠ¨ç¿»è¯‘å¼€å…³
  interfaceLanguage,
  feedUseGoogleTranslate,    // â† è®¢é˜…æºç¿»è¯‘è®¾ç½®
  true                       // â† é™„åŠ æ¨èID
)

// 3. ä¿å­˜åˆ° Chrome é˜…è¯»æ¸…å•
await chrome.readingList.addEntry({
  title: finalTitle,
  url: urlToSave  // â† å¯èƒ½æ˜¯åŸæ–‡é“¾æ¥æˆ–ç¿»è¯‘é“¾æ¥
})
```

**URL å†³ç­–é€»è¾‘** (`decideRecommendationUrl`):

```typescript
// src/core/reading-list/reading-list-manager.ts:129-170
// å…œåº•ï¼šå…ˆè¿˜åŸä¸ºåŸå§‹é“¾æ¥
const baseOriginalUrl = normalizeUrlForTracking(recommendation.url)

// å†³ç­–1ï¼šè®¢é˜…æºç¦ç”¨ç¿»è¯‘ â†’ åŸæ–‡é“¾æ¥
if (!feedUseGoogleTranslate) {
  return { url: appendRecommendationId(baseOriginalUrl, ...), title: ... }
}

// å†³ç­–2ï¼šå¯ç”¨è‡ªåŠ¨ç¿»è¯‘ + æ¨èå·²ç¿»è¯‘ â†’ ç”Ÿæˆç¿»è¯‘é“¾æ¥
if (autoTranslateEnabled && recommendation.translation) {
  const originalWithRec = appendRecommendationId(baseOriginalUrl, ...)
  const encodedUrl = encodeURIComponent(originalWithRec)
  const finalUrl = `https://translate.google.com/translate?sl=auto&tl=${interfaceLanguage}&u=${encodedUrl}`
  return { url: finalUrl, title: recommendation.translation.translatedTitle }
}

// å†³ç­–3ï¼šå…¶ä»–æƒ…å†µ â†’ åŸæ–‡é“¾æ¥
return { url: appendRecommendationId(baseOriginalUrl, ...), title: ... }
```

**å…³é”®ä¾èµ–**:
- âœ… `autoTranslateEnabled`: ç”¨æˆ·çš„å…¨å±€ç¿»è¯‘å¼€å…³
- âœ… `recommendation.translation`: æ¨èæ˜¯å¦å·²ç¿»è¯‘
- âš ï¸ `feedUseGoogleTranslate`: **è¿è¡Œæ—¶æŸ¥è¯¢**è®¢é˜…æºè®¾ç½®

#### 2.3.2 å¼¹çª—æ¨¡å¼æŠ•é€’

**å…¥å£**: `RecommendationService.generateRecommendations()` â†’ å¼¹çª—åˆ†æ”¯

```typescript
// src/core/recommender/RecommendationService.ts:544
if (deliveryMode === 'popup') {
  await sendRecommendationNotification(recommendations.length, {
    title: topRecommendation.title,
    source: topRecommendation.source,
    url: topRecommendation.url  // â† ä½¿ç”¨åŸå§‹ URL
  })
}
```

**å…³é”®ç‚¹**:
- æ¨èç›´æ¥å­˜å‚¨åœ¨æ•°æ®åº“
- å¼¹çª—å±•ç¤ºæ—¶ URL ç”±å‰ç«¯å†³ç­–ï¼ˆé€šè¿‡ `RecommendationView` ç»„ä»¶ï¼‰

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¨¡å¼åˆ‡æ¢æµç¨‹

### 3.1 åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼

**å…¥å£**: `background.ts` â†’ `DELIVERY_MODE_CHANGED` æ¶ˆæ¯å¤„ç†

```typescript
// src/background.ts:1252
case 'DELIVERY_MODE_CHANGED':
  (async () => {
    const { deliveryMode } = message
    
    // 1. ä¿å­˜æ–°æ¨¡å¼é…ç½®
    await saveRecommendationConfig({ ...prevConfig, deliveryMode })
    
    // 2. å¦‚æœåˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼
    if (deliveryMode === 'readingList' && ReadingListManager.isAvailable()) {
      // 2.1 æŸ¥è¯¢æ´»è·ƒæ¨è
      const activeRecs = await db.recommendations
        .filter(rec => {
          const isActive = !rec.status || rec.status === 'active'
          const isUnreadAndNotDismissed = !rec.isRead && rec.feedback !== 'dismissed'
          const isNotLater = rec.feedback !== 'later'
          return isActive && isUnreadAndNotDismissed && isNotLater
        })
        .toArray()
      
      // 2.2 è·å–é…ç½®
      const uiConfigResult = await chrome.storage.sync.get('ui_config')
      const autoTranslate = !!(uiConfigResult?.ui_config?.autoTranslate)
      const interfaceLanguage = navigator.language || 'zh-CN'
      
      // 2.3 é€ä¸ªè½¬ç§»åˆ°é˜…è¯»æ¸…å•
      for (const rec of activeRecs) {
        await ReadingListManager.saveRecommendation(
          rec, 
          autoTranslate,           // â† å½“å‰çš„å…¨å±€ç¿»è¯‘å¼€å…³
          interfaceLanguage, 
          autoAddedPrefix
        )
      }
    }
  })()
```

**é—®é¢˜ç‚¹ 1**: **è®¢é˜…æºè®¾ç½®çš„è¿è¡Œæ—¶æŸ¥è¯¢**

æ¯æ¬¡è°ƒç”¨ `saveRecommendation` æ—¶ï¼š
```typescript
// å†…éƒ¨ä¼šé‡æ–°æŸ¥è¯¢è®¢é˜…æºè®¾ç½®
const feed = await feedManager.getFeedByUrl(recommendation.sourceUrl)
feedUseGoogleTranslate = feed.useGoogleTranslate !== false
```

**å¯èƒ½å¯¼è‡´çš„é—®é¢˜**:
1. **è®¢é˜…æºè®¾ç½®å˜æ›´**: å¦‚æœç”¨æˆ·åœ¨æ¨èç”Ÿæˆåä¿®æ”¹äº†è®¢é˜…æºçš„ç¿»è¯‘è®¾ç½®
   - æ¨èç”Ÿæˆæ—¶ï¼šè®¢é˜…æºå…è®¸ç¿»è¯‘ â†’ `recommendation.translation` æœ‰æ•°æ®
   - æ¨¡å¼åˆ‡æ¢æ—¶ï¼šè®¢é˜…æºç¦ç”¨ç¿»è¯‘ â†’ æŸ¥è¯¢å¾—åˆ° `feedUseGoogleTranslate = false`
   - ç»“æœï¼šæœ‰ç¿»è¯‘æ•°æ®ä½†è¢«å†³ç­–ä¸ºä½¿ç”¨åŸæ–‡é“¾æ¥ âŒ

2. **æ•°æ®åº“æŸ¥è¯¢å¤±è´¥**: å¦‚æœ `recommendation.sourceUrl` ä¸å‡†ç¡®æˆ–è®¢é˜…æºå·²åˆ é™¤
   - æŸ¥è¯¢å¤±è´¥ â†’ é»˜è®¤ `feedUseGoogleTranslate = true`
   - ç»“æœï¼šå†³ç­–å¯èƒ½ä¸é¢„æœŸä¸ç¬¦

3. **æ€§èƒ½é—®é¢˜**: æ¯ä¸ªæ¨èéƒ½è¦æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“
   - å¦‚æœæœ‰ 10 æ¡æ¨èï¼Œå°±è¦æŸ¥è¯¢ 10 æ¬¡
   - éƒ¨åˆ†æ¨èå¯èƒ½æ¥è‡ªåŒä¸€ä¸ªè®¢é˜…æºï¼Œé€ æˆé‡å¤æŸ¥è¯¢

### 3.2 åˆ‡æ¢å›å¼¹çª—æ¨¡å¼

**å…¥å£**: `background.ts` â†’ `DELIVERY_MODE_CHANGED` æ¶ˆæ¯å¤„ç†

```typescript
// src/background.ts:1294
if (deliveryMode === 'popup') {
  // 1. æŸ¥è¯¢é˜…è¯»æ¸…å•æ¡ç›®
  const entries = await chrome.readingList.query({})
  
  // 2. ä»…ç§»é™¤è‡ªåŠ¨æ·»åŠ çš„æ¡ç›®ï¼ˆğŸ¤« å‰ç¼€ï¼‰
  const autoAddedEntries = entries.filter(e => e.title?.startsWith(autoAddedPrefix))
  
  // 3. é€ä¸ªç§»é™¤å¹¶æ¢å¤æ¨è
  for (const entry of autoAddedEntries) {
    await chrome.readingList.removeEntry({ url: entry.url })
    
    // 4. æ¢å¤æ¨èåˆ°æ´»è·ƒçŠ¶æ€
    const normalizedUrl = ReadingListManager.normalizeUrlForTracking(entry.url)
    const rlEntry = await db.readingListEntries.get(normalizedUrl)
    
    if (rlEntry?.recommendationId) {
      await db.recommendations.update(rlEntry.recommendationId, {
        savedToReadingList: false,
        status: 'active'
      })
    }
    
    await db.readingListEntries.delete(normalizedUrl)
  }
}
```

**é—®é¢˜ç‚¹ 2**: **URL åŒ¹é…å¤±è´¥**

é˜…è¯»æ¸…å•æ¡ç›®çš„ `entry.url` å¯èƒ½æ˜¯ï¼š
- **åŸæ–‡é“¾æ¥**: `https://example.com/article?sf_rec=rec-123`
- **ç¿»è¯‘é“¾æ¥**: `https://translate.google.com/translate?u=https%3A%2F%2Fexample.com%2Farticle%3Fsf_rec%3Drec-123&...`

æ•°æ®åº“æŸ¥è¯¢æ—¶ï¼š
```typescript
const normalizedUrl = ReadingListManager.normalizeUrlForTracking(entry.url)
const rlEntry = await db.readingListEntries.get(normalizedUrl)
```

`readingListEntries` è¡¨çš„æ•°æ®æ˜¯åœ¨ `saveRecommendation` æ—¶å†™å…¥çš„ï¼š
```typescript
// src/core/reading-list/reading-list-manager.ts:285
const normalizedUrl = ReadingListManager.normalizeUrlForTracking(urlToSave)
await db.readingListEntries.put({
  normalizedUrl,  // â† ä¸»é”®
  url: urlToSave, // â† å¯èƒ½æ˜¯åŸæ–‡æˆ–ç¿»è¯‘é“¾æ¥
  ...
})
```

**å…³é”®é—®é¢˜**:
- å¦‚æœä¿å­˜æ—¶ç”¨çš„æ˜¯**ç¿»è¯‘é“¾æ¥**ï¼Œ`urlToSave` å°±æ˜¯ç¿»è¯‘é“¾æ¥
- ç§»é™¤æ—¶æŸ¥è¯¢ `normalizeUrlForTracking(entry.url)` å¾—åˆ°**åŸå§‹ URL**
- ä½†æ•°æ®åº“ä¸­å­˜çš„ `normalizedUrl` å¯èƒ½åŸºäº**ç¿»è¯‘é“¾æ¥**è§„èŒƒåŒ–
- **ç»“æœ**: æŸ¥è¯¢ä¸åˆ° `rlEntry`ï¼Œæ¨èæ— æ³•æ¢å¤ âŒ

---

## ç¬¬å››éƒ¨åˆ†ï¼šé—®é¢˜æ ¹æºåˆ†æ

### 4.1 æ ¸å¿ƒçŸ›ç›¾

**æ¨èç”Ÿæˆæ—¶çš„çŠ¶æ€**:
```typescript
{
  url: "https://example.com/article",        // åŸå§‹ URL
  translation: {
    translatedTitle: "...",
    ...
  },
  sourceUrl: "https://example.com/feed.xml"  // RSS æº
}
```

**å†³ç­–æ—¶éœ€è¦çš„ä¿¡æ¯**:
1. âœ… `autoTranslateEnabled`: å…¨å±€ç¿»è¯‘å¼€å…³ï¼ˆæ¥è‡ª UI é…ç½®ï¼‰
2. âœ… `recommendation.translation`: æ¨èæ˜¯å¦å·²ç¿»è¯‘ï¼ˆå·²å­˜å‚¨ï¼‰
3. âš ï¸ `feedUseGoogleTranslate`: **è®¢é˜…æºç¿»è¯‘è®¾ç½®**ï¼ˆéœ€è¦è¿è¡Œæ—¶æŸ¥è¯¢ï¼‰

### 4.2 ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢è®¢é˜…æºè®¾ç½®ï¼Ÿ

**è®¾è®¡æ„å›¾**: å°Šé‡ç”¨æˆ·å¯¹ç‰¹å®šè®¢é˜…æºçš„ç¿»è¯‘åå¥½

åœºæ™¯ç¤ºä¾‹ï¼š
- ç”¨æˆ·è®¢é˜…äº†è‹±æ–‡æŠ€æœ¯åšå®¢ï¼Œ**æƒ³è¦**çœ‹ç¿»è¯‘ç‰ˆ
- ç”¨æˆ·è®¢é˜…äº†ä¸­æ–‡æ–°é—»ç½‘ç«™ï¼Œ**ä¸æƒ³è¦**çœ‹ç¿»è¯‘ç‰ˆï¼ˆä¼šç¿»è¯‘æˆè‹±æ–‡ï¼‰

è®¢é˜…æºçº§åˆ«çš„ `useGoogleTranslate` è®¾ç½®å…è®¸ç”¨æˆ·ç²¾ç»†æ§åˆ¶ã€‚

### 4.3 é—®é¢˜çš„æœ¬è´¨

**æ—¶é—´å·®å¯¼è‡´çš„ä¸ä¸€è‡´**:

```
æ—¶é—´çº¿:
T1: æ¨èç”Ÿæˆ
    - è®¢é˜…æº A: useGoogleTranslate = true
    - ç”Ÿæˆç¿»è¯‘é“¾æ¥å¹¶ä¿å­˜åˆ°é˜…è¯»æ¸…å•
    - æ•°æ®åº“è®°å½•: normalizedUrl åŸºäºç¿»è¯‘é“¾æ¥

T2: ç”¨æˆ·ä¿®æ”¹è®¢é˜…æºè®¾ç½®
    - è®¢é˜…æº A: useGoogleTranslate = false

T3: æ¨¡å¼åˆ‡æ¢ï¼ˆé˜…è¯»æ¸…å• â†’ å¼¹çª—ï¼‰
    - æŸ¥è¯¢è®¢é˜…æºè®¾ç½®: useGoogleTranslate = false
    - å†³ç­–: åº”ä½¿ç”¨åŸæ–‡é“¾æ¥
    - å°è¯•æŸ¥è¯¢æ•°æ®åº“: normalizeUrlForTracking(åŸæ–‡é“¾æ¥)
    - ç»“æœ: æŸ¥è¯¢ä¸åˆ° rlEntryï¼ˆå› ä¸ºå­˜çš„æ˜¯ç¿»è¯‘é“¾æ¥çš„è§„èŒƒåŒ–URLï¼‰
    - æ¨èæ— æ³•æ¢å¤ âŒ
```

### 4.4 æ•°æ®ä¸ä¸€è‡´çš„ç´¯ç§¯

**å¤šæ¬¡ä¿®å¤æœªèƒ½è§£å†³çš„åŸå› **:
1. **ç¼ºå°‘çŠ¶æ€å¿«ç…§**: æ¨èç”Ÿæˆæ—¶çš„å†³ç­–ä¾æ®æœªè¢«ä¿å­˜
2. **è¿è¡Œæ—¶é‡æ–°å†³ç­–**: æ¨¡å¼åˆ‡æ¢æ—¶é‡æ–°æŸ¥è¯¢ï¼Œå¯èƒ½å¾—åˆ°ä¸åŒç»“æœ
3. **URL å˜æ¢çš„ä¸å¯¹ç§°**: åŸæ–‡ â†’ ç¿»è¯‘å®¹æ˜“ï¼Œç¿»è¯‘ â†’ åŸæ–‡å­˜åœ¨æ­§ä¹‰
4. **ç¼ºå°‘å…œåº•æœºåˆ¶**: URL åŒ¹é…å¤±è´¥æ—¶æ²¡æœ‰å¤‡ç”¨æŸ¥è¯¢ç­–ç•¥

---

## ç¬¬äº”éƒ¨åˆ†ï¼šè§£å†³æ–¹æ¡ˆè®¾è®¡

### 5.1 è®¾è®¡åŸåˆ™

1. **ä¸€è‡´æ€§ä¼˜å…ˆ**: æ¨èçš„ URL ç±»å‹åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´
2. **å¿«ç…§å†³ç­–**: å…³é”®å†³ç­–ä¾æ®åœ¨æ¨èç”Ÿæˆæ—¶ä¿å­˜ï¼Œåç»­ä¸é‡æ–°æŸ¥è¯¢
3. **æ˜ç¡®çš„çœŸç›¸æº**: URL å­˜å‚¨éµå¾ªå•ä¸€è§„èŒƒ
4. **å®Œå–„çš„å…œåº•**: å¤šå±‚æŸ¥è¯¢ç­–ç•¥ç¡®ä¿æ•°æ®æ¢å¤

### 5.2 æ ¸å¿ƒç­–ç•¥ï¼šå†³ç­–çŠ¶æ€å¿«ç…§

**åœ¨æ¨èç”Ÿæˆæ—¶ä¿å­˜å†³ç­–ä¾æ®**ï¼Œé¿å…åç»­é‡æ–°æŸ¥è¯¢ã€‚

#### æ–¹æ¡ˆ Aï¼šæ‰©å±• Recommendation ç±»å‹ï¼ˆæ¨è âœ…ï¼‰

```typescript
interface Recommendation {
  // ... ç°æœ‰å­—æ®µ
  
  // æ–°å¢ï¼šURL å†³ç­–å¿«ç…§
  urlDecision?: {
    // è®¢é˜…æºæ˜¯å¦å…è®¸ç¿»è¯‘ï¼ˆå¿«ç…§ï¼‰
    feedAllowsTranslation: boolean
    
    // å†³ç­–æ—¶ä½¿ç”¨çš„æœ€ç»ˆ URL ç±»å‹
    urlType: 'original' | 'translated'
    
    // å¦‚æœæ˜¯ç¿»è¯‘é“¾æ¥ï¼Œè®°å½•åŸå§‹ URLï¼ˆä¾¿äºåå‘æŸ¥è¯¢ï¼‰
    originalUrl?: string
    
    // å†³ç­–æ—¶é—´æˆ³
    decidedAt: number
  }
}
```

**ä¼˜åŠ¿**:
- âœ… å®Œæ•´è®°å½•å†³ç­–ä¸Šä¸‹æ–‡
- âœ… æ”¯æŒå®¡è®¡å’Œè°ƒè¯•
- âœ… æœªæ¥å¯æ‰©å±•ï¼ˆå¦‚è®°å½•å†³ç­–ç®—æ³•ç‰ˆæœ¬ï¼‰

**å®æ–½å¤æ‚åº¦**: ä¸­ç­‰ï¼ˆéœ€è¦ä¿®æ”¹ç±»å‹å®šä¹‰å’Œæ•°æ®è¿ç§»ï¼‰

#### æ–¹æ¡ˆ Bï¼šç®€åŒ–æ–¹æ¡ˆ - ä»…ä¿å­˜è®¢é˜…æºè®¾ç½®ï¼ˆå¯è¡Œ â­ï¼‰

```typescript
interface Recommendation {
  // ... ç°æœ‰å­—æ®µ
  
  // æ–°å¢ï¼šè®¢é˜…æºç¿»è¯‘è®¾ç½®ï¼ˆå¿«ç…§ï¼‰
  feedUseGoogleTranslate?: boolean
}
```

**ä¼˜åŠ¿**:
- âœ… ä¿®æ”¹æœ€å°ï¼Œå‘åå…¼å®¹
- âœ… æ»¡è¶³å½“å‰éœ€æ±‚
- âœ… å¯é€‰å­—æ®µï¼Œä¸å½±å“ç°æœ‰æ•°æ®

**åŠ£åŠ¿**:
- âš ï¸ ä¿¡æ¯ä¸å®Œæ•´ï¼Œè°ƒè¯•å›°éš¾
- âš ï¸ æœªæ¥æ‰©å±•æ€§å¼±

### 5.3 æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ A + URL è§„èŒƒåŒ–ç­–ç•¥

**å®Œæ•´æµç¨‹**:

#### 5.3.1 æ¨èç”Ÿæˆé˜¶æ®µ

```typescript
// src/core/recommender/RecommendationService.ts
private async saveRecommendations(...) {
  for (const article of recommendedArticles) {
    // 1. æŸ¥è¯¢è®¢é˜…æºè®¾ç½®ï¼ˆä»…åœ¨ç”Ÿæˆæ—¶æŸ¥è¯¢ä¸€æ¬¡ï¼‰
    let feedUseGoogleTranslate = true
    if (article.feedId) {
      const feed = await db.discoveredFeeds.get(article.feedId)
      if (feed) {
        feedUseGoogleTranslate = feed.useGoogleTranslate !== false
      }
    }
    
    // 2. åˆ›å»ºæ¨èå¯¹è±¡
    const recommendation: Recommendation = {
      id: `rec-${now}-${index}`,
      url: normalizedArticleUrl,  // å§‹ç»ˆå­˜å‚¨åŸå§‹ URL
      title: article.title,
      sourceUrl: feedUrl,
      translation: article.aiAnalysis?.translatedTitle ? {...} : undefined,
      
      // æ–°å¢ï¼šä¿å­˜ URL å†³ç­–å¿«ç…§
      urlDecision: {
        feedAllowsTranslation: feedUseGoogleTranslate,
        urlType: 'original',  // æ•°æ®åº“ä¸­å§‹ç»ˆå­˜å‚¨åŸå§‹ç±»å‹
        decidedAt: now
      }
    }
    
    // 3. ä¿å­˜åˆ°æ•°æ®åº“
    await db.recommendations.add(recommendation)
  }
}
```

#### 5.3.2 é˜…è¯»æ¸…å•æŠ•é€’é˜¶æ®µ

```typescript
// src/core/recommender/RecommendationService.ts
if (deliveryMode === 'readingList' && ReadingListManager.isAvailable()) {
  for (const rec of recommendations) {
    // ç›´æ¥ä½¿ç”¨å¿«ç…§çš„è®¢é˜…æºè®¾ç½®ï¼Œä¸å†æŸ¥è¯¢
    const feedUseGoogleTranslate = rec.urlDecision?.feedAllowsTranslation ?? true
    
    await ReadingListManager.saveRecommendation(
      rec,
      uiConfig.autoTranslate,
      interfaceLanguage,
      titlePrefix,
      feedUseGoogleTranslate  // ä¼ å…¥å¿«ç…§å€¼
    )
  }
}
```

#### 5.3.3 æ¨¡å¼åˆ‡æ¢é˜¶æ®µ

```typescript
// src/background.ts - DELIVERY_MODE_CHANGED
if (deliveryMode === 'readingList') {
  // æ‰¹é‡è·å–è®¢é˜…æºè®¾ç½®ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
  const feedManager = new FeedManager()
  const feedSettingsMap = new Map<string, boolean>()
  
  const uniqueSourceUrls = [...new Set(activeRecs.map(r => r.sourceUrl).filter(Boolean))]
  
  for (const sourceUrl of uniqueSourceUrls) {
    try {
      const feed = await feedManager.getFeedByUrl(sourceUrl)
      if (feed) {
        feedSettingsMap.set(sourceUrl, feed.useGoogleTranslate !== false)
      }
    } catch {
      feedSettingsMap.set(sourceUrl, true)
    }
  }
  
  for (const rec of activeRecs) {
    // ä¼˜å…ˆä½¿ç”¨å¿«ç…§ï¼Œå¦‚æœæ²¡æœ‰å¿«ç…§åˆ™ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ç»“æœ
    const feedUseGoogleTranslate = 
      rec.urlDecision?.feedAllowsTranslation ?? 
      (rec.sourceUrl ? feedSettingsMap.get(rec.sourceUrl) : true) ??
      true
    
    await ReadingListManager.saveRecommendation(
      rec,
      autoTranslate,
      interfaceLanguage,
      autoAddedPrefix,
      feedUseGoogleTranslate
    )
  }
}
```

#### 5.3.4 æ¢å¤æ¨èæ—¶çš„å…œåº•ç­–ç•¥

```typescript
// src/background.ts - åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
if (deliveryMode === 'popup') {
  const entries = await chrome.readingList.query({})
  const autoAddedEntries = entries.filter(e => e.title?.startsWith(autoAddedPrefix))
  
  for (const entry of autoAddedEntries) {
    await chrome.readingList.removeEntry({ url: entry.url })
    
    // å¤šå±‚æŸ¥è¯¢ç­–ç•¥
    const normalizedUrl = ReadingListManager.normalizeUrlForTracking(entry.url)
    
    // å°è¯•1: ä½¿ç”¨è§„èŒƒåŒ– URL æŸ¥è¯¢
    let rlEntry = await db.readingListEntries.get(normalizedUrl)
    
    // å°è¯•2: å¦‚æœæ˜¯ç¿»è¯‘é“¾æ¥ï¼Œæå–åŸå§‹ URL å†æŸ¥è¯¢
    if (!rlEntry && entry.url.includes('translate.google.com')) {
      try {
        const urlObj = new URL(entry.url)
        const originalUrl = urlObj.searchParams.get('u')
        if (originalUrl) {
          const decodedOriginal = decodeURIComponent(originalUrl)
          const normalizedOriginal = ReadingListManager.normalizeUrlForTracking(decodedOriginal)
          rlEntry = await db.readingListEntries.get(normalizedOriginal)
        }
      } catch (err) {
        bgLogger.warn('æå–ç¿»è¯‘é“¾æ¥åŸå§‹ URL å¤±è´¥', err)
      }
    }
    
    // å°è¯•3: éå†æ‰€æœ‰æ¡ç›®æŸ¥æ‰¾ï¼ˆæœ€åå…œåº•ï¼‰
    if (!rlEntry) {
      const allEntries = await db.readingListEntries.toArray()
      rlEntry = allEntries.find(e => 
        ReadingListManager.normalizeUrlForTracking(e.url) === normalizedUrl
      )
    }
    
    // æ¢å¤æ¨è
    if (rlEntry?.recommendationId) {
      await db.recommendations.update(rlEntry.recommendationId, {
        savedToReadingList: false,
        status: 'active'
      })
      bgLogger.info('å·²æ¢å¤æ¨èåˆ°å¼¹çª—æ¨¡å¼', { recommendationId: rlEntry.recommendationId })
    } else {
      bgLogger.warn('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„æ¨èæ¡ç›®', { url: entry.url, normalizedUrl })
    }
    
    await db.readingListEntries.delete(normalizedUrl)
  }
}
```

### 5.4 æ•°æ®åº“æ¶æ„è°ƒæ•´

#### 5.4.1 Recommendation è¡¨æ‰©å±•

```typescript
// src/types/database.ts
export interface Recommendation {
  // ... ç°æœ‰å­—æ®µ
  
  /** URL å†³ç­–å¿«ç…§ï¼ˆPhase 15: è§£å†³æ¨¡å¼åˆ‡æ¢ URL æ··ä¹±é—®é¢˜ï¼‰ */
  urlDecision?: {
    /** è®¢é˜…æºæ˜¯å¦å…è®¸ç¿»è¯‘ï¼ˆç”Ÿæˆæ—¶çš„å¿«ç…§ï¼‰ */
    feedAllowsTranslation: boolean
    
    /** URL ç±»å‹ */
    urlType: 'original' | 'translated'
    
    /** å¦‚æœå­˜å‚¨çš„æ˜¯ç¿»è¯‘é“¾æ¥ï¼Œè®°å½•åŸå§‹ URL */
    originalUrl?: string
    
    /** å†³ç­–æ—¶é—´æˆ³ */
    decidedAt: number
  }
}
```

#### 5.4.2 æ•°æ®è¿ç§»ç­–ç•¥

```typescript
// ä¸ºç°æœ‰æ¨èè¡¥å……é»˜è®¤å€¼
async function migrateRecommendations() {
  const recommendations = await db.recommendations.toArray()
  
  for (const rec of recommendations) {
    if (!rec.urlDecision) {
      // ä¸ºæ—§æ•°æ®è¡¥å……é»˜è®¤å¿«ç…§
      await db.recommendations.update(rec.id, {
        urlDecision: {
          feedAllowsTranslation: true,  // é»˜è®¤å…è®¸
          urlType: 'original',
          decidedAt: rec.recommendedAt || Date.now()
        }
      })
    }
  }
}
```

### 5.5 å…³é”®ä¿®æ”¹ç‚¹æ±‡æ€»

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| `src/types/database.ts` | æ‰©å±• Recommendation æ¥å£ï¼Œæ·»åŠ  urlDecision å­—æ®µ | P0 |
| `src/core/recommender/RecommendationService.ts` | ç”Ÿæˆæ¨èæ—¶ä¿å­˜ urlDecision å¿«ç…§ | P0 |
| `src/core/recommender/RecommendationService.ts` | é˜…è¯»æ¸…å•æŠ•é€’ä½¿ç”¨å¿«ç…§å€¼ | P0 |
| `src/core/reading-list/reading-list-manager.ts` | saveRecommendation ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„è®¾ç½® | P0 |
| `src/background.ts` | æ¨¡å¼åˆ‡æ¢æ—¶æ‰¹é‡æŸ¥è¯¢+ä½¿ç”¨å¿«ç…§ | P0 |
| `src/background.ts` | æ¢å¤æ¨èæ—¶çš„å¤šå±‚æŸ¥è¯¢å…œåº• | P1 |
| æ•°æ®è¿ç§»è„šæœ¬ | ä¸ºç°æœ‰æ•°æ®è¡¥å……é»˜è®¤ urlDecision | P1 |

---

## ç¬¬å…­éƒ¨åˆ†ï¼šæµ‹è¯•åœºæ™¯è®¾è®¡

### 6.1 æ ¸å¿ƒæµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1: åŸºæœ¬æ¨¡å¼åˆ‡æ¢ï¼ˆå…è®¸ç¿»è¯‘ï¼‰

**å‰ç½®æ¡ä»¶**:
- è®¢é˜…æº A: `useGoogleTranslate = true`
- å…¨å±€è‡ªåŠ¨ç¿»è¯‘: å¯ç”¨
- æ¨è R1 æ¥è‡ªè®¢é˜…æº Aï¼Œå·²ç¿»è¯‘

**æ“ä½œæ­¥éª¤**:
1. ç”Ÿæˆæ¨è R1
2. åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼
3. éªŒè¯é˜…è¯»æ¸…å•ä¸­çš„æ¡ç›®æ˜¯ç¿»è¯‘é“¾æ¥
4. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
5. éªŒè¯æ¨è R1 æ¢å¤åˆ°æ´»è·ƒçŠ¶æ€

**é¢„æœŸç»“æœ**:
- âœ… é˜…è¯»æ¸…å•æ¡ç›®: ç¿»è¯‘é“¾æ¥ + ç¿»è¯‘æ ‡é¢˜
- âœ… æ¨èæ¢å¤æˆåŠŸ

#### åœºæ™¯ 2: åŸºæœ¬æ¨¡å¼åˆ‡æ¢ï¼ˆç¦ç”¨ç¿»è¯‘ï¼‰

**å‰ç½®æ¡ä»¶**:
- è®¢é˜…æº B: `useGoogleTranslate = false`
- å…¨å±€è‡ªåŠ¨ç¿»è¯‘: å¯ç”¨
- æ¨è R2 æ¥è‡ªè®¢é˜…æº B

**æ“ä½œæ­¥éª¤**:
1. ç”Ÿæˆæ¨è R2
2. åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼
3. éªŒè¯é˜…è¯»æ¸…å•ä¸­çš„æ¡ç›®æ˜¯åŸæ–‡é“¾æ¥
4. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
5. éªŒè¯æ¨è R2 æ¢å¤åˆ°æ´»è·ƒçŠ¶æ€

**é¢„æœŸç»“æœ**:
- âœ… é˜…è¯»æ¸…å•æ¡ç›®: åŸæ–‡é“¾æ¥ + åŸæ–‡æ ‡é¢˜
- âœ… æ¨èæ¢å¤æˆåŠŸ

#### åœºæ™¯ 3: è®¢é˜…æºè®¾ç½®å˜æ›´ï¼ˆå…³é”®åœºæ™¯ï¼‰

**å‰ç½®æ¡ä»¶**:
- è®¢é˜…æº A: `useGoogleTranslate = true`
- å…¨å±€è‡ªåŠ¨ç¿»è¯‘: å¯ç”¨
- æ¨è R1 å·²ç”Ÿæˆå¹¶ä¿å­˜åˆ°é˜…è¯»æ¸…å•ï¼ˆç¿»è¯‘é“¾æ¥ï¼‰

**æ“ä½œæ­¥éª¤**:
1. ç”¨æˆ·ä¿®æ”¹è®¢é˜…æº A: `useGoogleTranslate = false`
2. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
3. éªŒè¯æ¨è R1 æ¢å¤çŠ¶æ€

**é¢„æœŸç»“æœ**:
- âœ… æ¨è R1 æˆåŠŸæ¢å¤ï¼ˆä½¿ç”¨å¿«ç…§ï¼Œå¿½ç•¥æ–°è®¾ç½®ï¼‰
- âœ… `urlDecision.feedAllowsTranslation = true` ï¼ˆå¿«ç…§ï¼‰

#### åœºæ™¯ 4: æ‰¹é‡æ¨èï¼Œæ··åˆè®¢é˜…æº

**å‰ç½®æ¡ä»¶**:
- è®¢é˜…æº A: `useGoogleTranslate = true`
- è®¢é˜…æº B: `useGoogleTranslate = false`
- æ¨è R1, R2, R3 æ¥è‡ª Aï¼ˆç¿»è¯‘ï¼‰
- æ¨è R4, R5 æ¥è‡ª Bï¼ˆåŸæ–‡ï¼‰

**æ“ä½œæ­¥éª¤**:
1. åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼
2. éªŒè¯é˜…è¯»æ¸…å•ä¸­çš„ 5 ä¸ªæ¡ç›®
3. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
4. éªŒè¯æ‰€æœ‰ 5 ä¸ªæ¨èæ¢å¤

**é¢„æœŸç»“æœ**:
- âœ… R1-R3: ç¿»è¯‘é“¾æ¥
- âœ… R4-R5: åŸæ–‡é“¾æ¥
- âœ… æ‰€æœ‰æ¨èæˆåŠŸæ¢å¤

#### åœºæ™¯ 5: è®¢é˜…æºåˆ é™¤åçš„æ¨¡å¼åˆ‡æ¢

**å‰ç½®æ¡ä»¶**:
- æ¨è R1 æ¥è‡ªè®¢é˜…æº A
- ç”¨æˆ·åˆ é™¤è®¢é˜…æº A

**æ“ä½œæ­¥éª¤**:
1. åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼
2. éªŒè¯ R1 è¢«æ­£ç¡®ä¿å­˜ï¼ˆä½¿ç”¨å¿«ç…§æˆ–é»˜è®¤å€¼ï¼‰
3. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
4. éªŒè¯ R1 æ¢å¤

**é¢„æœŸç»“æœ**:
- âœ… ä½¿ç”¨å¿«ç…§å€¼æˆ–é»˜è®¤å€¼ï¼ˆå…è®¸ç¿»è¯‘ï¼‰
- âœ… æ¨èæˆåŠŸæ¢å¤

#### åœºæ™¯ 6: å…¨å±€ç¿»è¯‘å¼€å…³å˜æ›´

**å‰ç½®æ¡ä»¶**:
- å…¨å±€è‡ªåŠ¨ç¿»è¯‘: å¯ç”¨
- æ¨è R1 å·²ç¿»è¯‘å¹¶ä¿å­˜åˆ°é˜…è¯»æ¸…å•

**æ“ä½œæ­¥éª¤**:
1. ç”¨æˆ·å…³é—­å…¨å±€è‡ªåŠ¨ç¿»è¯‘
2. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
3. éªŒè¯ R1 æ¢å¤

**é¢„æœŸç»“æœ**:
- âœ… æ¨èæˆåŠŸæ¢å¤
- âš ï¸ æ–°ç”Ÿæˆçš„æ¨èä¸å†ä½¿ç”¨ç¿»è¯‘é“¾æ¥

### 6.2 è¾¹ç•Œæµ‹è¯•åœºæ™¯

#### åœºæ™¯ 7: æ— å¿«ç…§æ•°æ®çš„æ—§æ¨è

**å‰ç½®æ¡ä»¶**:
- æ¨è R1 æ˜¯æ•°æ®è¿ç§»å‰ç”Ÿæˆçš„ï¼ˆæ—  urlDecision å­—æ®µï¼‰

**æ“ä½œæ­¥éª¤**:
1. åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼
2. éªŒè¯ä½¿ç”¨é»˜è®¤ç­–ç•¥

**é¢„æœŸç»“æœ**:
- âœ… ä½¿ç”¨é»˜è®¤å€¼ï¼ˆ`feedAllowsTranslation = true`ï¼‰
- âœ… æ­£å¸¸ä¿å­˜åˆ°é˜…è¯»æ¸…å•

#### åœºæ™¯ 8: é˜…è¯»æ¸…å•æ¡ç›®æ‰‹åŠ¨ä¿®æ”¹

**å‰ç½®æ¡ä»¶**:
- æ¨è R1 å·²ä¿å­˜åˆ°é˜…è¯»æ¸…å•
- ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨æ ‡è®°ä¸ºå·²è¯»

**æ“ä½œæ­¥éª¤**:
1. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
2. éªŒè¯æ¨èçŠ¶æ€

**é¢„æœŸç»“æœ**:
- âœ… æ¨è R1 æ ‡è®°ä¸ºå·²è¯»
- âœ… ä»æ´»è·ƒæ¨èæ± ç§»é™¤

#### åœºæ™¯ 9: ç½‘ç»œé”™è¯¯æ—¶çš„å…œåº•

**å‰ç½®æ¡ä»¶**:
- æ¨è R1 å·²ä¿å­˜åˆ°é˜…è¯»æ¸…å•
- æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸

**æ“ä½œæ­¥éª¤**:
1. æ¨¡æ‹Ÿæ•°æ®åº“é”™è¯¯
2. åˆ‡æ¢å›å¼¹çª—æ¨¡å¼
3. éªŒè¯é”™è¯¯å¤„ç†

**é¢„æœŸç»“æœ**:
- âœ… ä¸æŠ›å‡ºæœªæ•è·å¼‚å¸¸
- âœ… è®°å½•è­¦å‘Šæ—¥å¿—
- âš ï¸ éƒ¨åˆ†æ¨èå¯èƒ½æ— æ³•æ¢å¤ï¼ˆè®°å½•å¤±è´¥åŸå› ï¼‰

### 6.3 æ€§èƒ½æµ‹è¯•

#### åœºæ™¯ 10: å¤§æ‰¹é‡æ¨èï¼ˆ50æ¡ï¼‰

**å‰ç½®æ¡ä»¶**:
- 50 æ¡æ¨èæ¥è‡ª 10 ä¸ªä¸åŒè®¢é˜…æº

**æ“ä½œæ­¥éª¤**:
1. åˆ‡æ¢åˆ°é˜…è¯»æ¸…å•æ¨¡å¼
2. æµ‹é‡è½¬ç§»è€—æ—¶
3. éªŒè¯æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°

**é¢„æœŸç»“æœ**:
- âœ… è®¢é˜…æºè®¾ç½®ä»…æŸ¥è¯¢ 10 æ¬¡ï¼ˆæ‰¹é‡ä¼˜åŒ–ï¼‰
- âœ… æ€»è€—æ—¶ < 5 ç§’
- âœ… æ‰€æœ‰æ¨èæˆåŠŸè½¬ç§»

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå®æ–½è®¡åˆ’ä¸é£é™©è¯„ä¼°

### 7.1 åˆ†é˜¶æ®µå®æ–½

#### Phase 1: æ•°æ®æ¨¡å‹æ‰©å±•ï¼ˆ2-3å°æ—¶ï¼‰
- [ ] æ‰©å±• `Recommendation` æ¥å£ï¼Œæ·»åŠ  `urlDecision` å­—æ®µ
- [ ] ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬
- [ ] å•å…ƒæµ‹è¯•ï¼šç±»å‹å®šä¹‰å’Œè¿ç§»é€»è¾‘

#### Phase 2: æ¨èç”Ÿæˆæ”¹é€ ï¼ˆ3-4å°æ—¶ï¼‰
- [ ] ä¿®æ”¹ `RecommendationService.saveRecommendations()`
- [ ] ç”Ÿæˆæ—¶ä¿å­˜ `urlDecision` å¿«ç…§
- [ ] å•å…ƒæµ‹è¯•ï¼šå¿«ç…§ä¿å­˜é€»è¾‘

#### Phase 3: é˜…è¯»æ¸…å•ç®¡ç†æ”¹é€ ï¼ˆ2-3å°æ—¶ï¼‰
- [ ] ä¿®æ”¹ `ReadingListManager.saveRecommendation()`
- [ ] ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ `feedUseGoogleTranslate` å‚æ•°
- [ ] å•å…ƒæµ‹è¯•ï¼šURL å†³ç­–é€»è¾‘

#### Phase 4: æ¨¡å¼åˆ‡æ¢æ”¹é€ ï¼ˆ4-5å°æ—¶ï¼‰
- [ ] ä¿®æ”¹ `background.ts` çš„ `DELIVERY_MODE_CHANGED` å¤„ç†å™¨
- [ ] å®ç°æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
- [ ] å®ç°å¤šå±‚æŸ¥è¯¢å…œåº•ç­–ç•¥
- [ ] å•å…ƒæµ‹è¯•ï¼šæ¨¡å¼åˆ‡æ¢é€»è¾‘

#### Phase 5: é›†æˆæµ‹è¯•ï¼ˆ3-4å°æ—¶ï¼‰
- [ ] å®ç°åœºæ™¯ 1-6 çš„é›†æˆæµ‹è¯•
- [ ] å®ç°è¾¹ç•Œæµ‹è¯•åœºæ™¯ 7-9
- [ ] æ€§èƒ½æµ‹è¯•åœºæ™¯ 10

#### Phase 6: æ•°æ®è¿ç§»ä¸å‘å¸ƒï¼ˆ1-2å°æ—¶ï¼‰
- [ ] åœ¨å¼€å‘ç¯å¢ƒè¿è¡Œè¿ç§»è„šæœ¬
- [ ] éªŒè¯è¿ç§»ç»“æœ
- [ ] å‡†å¤‡å‘å¸ƒæ–‡æ¡£

**æ€»è®¡**: 15-21 å°æ—¶

### 7.2 é£é™©è¯„ä¼°

#### é«˜é£é™©é¡¹

**R1: æ•°æ®è¿ç§»å¤±è´¥**
- **æ¦‚ç‡**: ä½
- **å½±å“**: é«˜ï¼ˆç”¨æˆ·æ•°æ®æŸåï¼‰
- **ç¼“è§£**: 
  - è¿ç§»å‰å¤‡ä»½æ•°æ®åº“
  - åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´éªŒè¯
  - æä¾›å›æ»šæœºåˆ¶

**R2: æ€§èƒ½é€€åŒ–**
- **æ¦‚ç‡**: ä¸­
- **å½±å“**: ä¸­ï¼ˆç”¨æˆ·ä½“éªŒä¸‹é™ï¼‰
- **ç¼“è§£**:
  - æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
  - æ€§èƒ½åŸºå‡†æµ‹è¯•
  - æ·»åŠ æ€§èƒ½ç›‘æ§æ—¥å¿—

#### ä¸­é£é™©é¡¹

**R3: å‘åå…¼å®¹æ€§é—®é¢˜**
- **æ¦‚ç‡**: ä¸­
- **å½±å“**: ä¸­ï¼ˆéƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸ï¼‰
- **ç¼“è§£**:
  - `urlDecision` è®¾ä¸ºå¯é€‰å­—æ®µ
  - æä¾›é»˜è®¤å€¼å…œåº•
  - å®Œå–„çš„å•å…ƒæµ‹è¯•è¦†ç›–

**R4: è¾¹ç•Œæƒ…å†µé—æ¼**
- **æ¦‚ç‡**: ä¸­
- **å½±å“**: ä½ï¼ˆç‰¹å®šåœºæ™¯å¤±è´¥ï¼‰
- **ç¼“è§£**:
  - è¯¦ç»†çš„æµ‹è¯•åœºæ™¯è®¾è®¡
  - å¤šå±‚å…œåº•ç­–ç•¥
  - å®Œå–„çš„é”™è¯¯æ—¥å¿—

#### ä½é£é™©é¡¹

**R5: ç”¨æˆ·ä½“éªŒå˜åŒ–**
- **æ¦‚ç‡**: ä½
- **å½±å“**: ä½
- **ç¼“è§£**:
  - æ ¸å¿ƒäº¤äº’ä¸å˜
  - ä»…å†…éƒ¨é€»è¾‘ä¼˜åŒ–

### 7.3 æˆåŠŸæ ‡å‡†

#### åŠŸèƒ½æ ‡å‡†
- âœ… æ‰€æœ‰æµ‹è¯•åœºæ™¯é€šè¿‡
- âœ… ç°æœ‰å•å…ƒæµ‹è¯•ä¸å—å½±å“
- âœ… æ€§èƒ½æ— æ˜æ˜¾é€€åŒ–ï¼ˆ< 10%ï¼‰

#### è´¨é‡æ ‡å‡†
- âœ… ä»£ç è¦†ç›–ç‡ â‰¥ 70%
- âœ… æ—  TypeScript ç±»å‹é”™è¯¯
- âœ… æ‰€æœ‰ä¿®æ”¹ç‚¹æœ‰å®Œæ•´æ³¨é‡Š

#### ç”¨æˆ·ä½“éªŒæ ‡å‡†
- âœ… æ¨¡å¼åˆ‡æ¢æµç•…ï¼ˆ< 3 ç§’ï¼‰
- âœ… æ¨èæ¢å¤ç‡ = 100%
- âœ… æ— æ•°æ®ä¸¢å¤±

### 7.4 å›æ»šæ–¹æ¡ˆ

å¦‚æœå‘ç°é‡å¤§é—®é¢˜ï¼Œå¯æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

1. **ç´§æ€¥å›æ»š**ï¼ˆ< 10åˆ†é’Ÿï¼‰:
   - åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
   - ç”¨æˆ·æ•°æ®ä¸å—å½±å“ï¼ˆæ–°å­—æ®µå¯é€‰ï¼‰

2. **æ•°æ®ä¿®å¤**ï¼ˆå¦‚éœ€è¦ï¼‰:
   - è¿è¡Œæ•°æ®æ¸…ç†è„šæœ¬
   - ç§»é™¤ `urlDecision` å­—æ®µï¼ˆå¯é€‰ï¼‰

3. **é—®é¢˜è¯Šæ–­**:
   - æ”¶é›†é”™è¯¯æ—¥å¿—
   - é‡ç°é—®é¢˜åœºæ™¯
   - ä¿®å¤åé‡æ–°å‘å¸ƒ

---

## ç¬¬å…«éƒ¨åˆ†ï¼šæ€»ç»“ä¸å»ºè®®

### 8.1 æ ¸å¿ƒæ´å¯Ÿ

1. **çŠ¶æ€å¿«ç…§æ˜¯å…³é”®**: æ¨èçš„ URL å†³ç­–ä¾èµ–äºå¤šä¸ªåŠ¨æ€å› ç´ ï¼Œå¿…é¡»åœ¨ç”Ÿæˆæ—¶å¿«ç…§ä¿å­˜
2. **æ•°æ®ä¸€è‡´æ€§ä¼˜äºå®æ—¶æ€§**: å®å¯ä½¿ç”¨è¿‡æ—¶ä½†ä¸€è‡´çš„å¿«ç…§ï¼Œä¹Ÿä¸è¦å®æ—¶æŸ¥è¯¢å¯¼è‡´ä¸ä¸€è‡´
3. **å®Œå–„çš„å…œåº•æœºåˆ¶**: URL åŒ¹é…å¤±è´¥æ—¶å¿…é¡»æœ‰å¤šå±‚å¤‡ç”¨ç­–ç•¥
4. **æ€§èƒ½ä¸æ­£ç¡®æ€§çš„å¹³è¡¡**: æ‰¹é‡æŸ¥è¯¢å‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œå¿«ç…§é¿å…é‡å¤æŸ¥è¯¢

### 8.2 é•¿æœŸä¼˜åŒ–å»ºè®®

1. **å¼•å…¥å†³ç­–ç‰ˆæœ¬å·**: æœªæ¥å¦‚æœ URL å†³ç­–é€»è¾‘å˜æ›´ï¼Œå¯åŸºäºç‰ˆæœ¬å·è¿ç§»æ•°æ®
2. **ç›‘æ§ä¸å‘Šè­¦**: æ·»åŠ æ¨èæ¢å¤å¤±è´¥çš„ç›‘æ§æŒ‡æ ‡
3. **ç”¨æˆ·è®¾ç½®å®¡è®¡**: è®°å½•è®¢é˜…æºè®¾ç½®å˜æ›´å†å²ï¼Œä¾¿äºè°ƒè¯•
4. **URL è§„èŒƒåŒ–æµ‹è¯•**: æ‰©å±•æµ‹è¯•è¦†ç›–æ›´å¤šè¾¹ç•Œæƒ…å†µï¼ˆç‰¹æ®Šå­—ç¬¦ã€ç¼–ç é—®é¢˜ç­‰ï¼‰

### 8.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç”¨æˆ·å®¡æ ¸ç‚¹**:
1. âœ… æ¶æ„è®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ
2. âœ… è§£å†³æ–¹æ¡ˆæ˜¯å¦å…¨é¢ï¼Ÿ
3. âœ… æµ‹è¯•åœºæ™¯æ˜¯å¦å……åˆ†ï¼Ÿ
4. âœ… å®æ–½è®¡åˆ’æ˜¯å¦å¯è¡Œï¼Ÿ

**å¾…ç”¨æˆ·ç¡®è®¤å**:
- å¼€å§‹ Phase 1 å®æ–½
- å®šæœŸåŒæ­¥è¿›å±•
- æ¯ä¸ª Phase å®Œæˆåè¯·ç”¨æˆ·éªŒè¯

---

## é™„å½•

### A. å…³é”®ä»£ç ä½ç½®ç´¢å¼•

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ | è¡Œå·èŒƒå›´ |
|------|----------|---------|
| æ¨èç”Ÿæˆ | `src/core/recommender/RecommendationService.ts` | 87-575 |
| æ¨èä¿å­˜ | `src/core/recommender/RecommendationService.ts` | 655-870 |
| URL å†³ç­– | `src/core/reading-list/reading-list-manager.ts` | 129-170 |
| é˜…è¯»æ¸…å•ä¿å­˜ | `src/core/reading-list/reading-list-manager.ts` | 180-350 |
| æ¨¡å¼åˆ‡æ¢å¤„ç† | `src/background.ts` | 1252-1350 |

### B. æ•°æ®åº“è¡¨ç»“æ„

```typescript
// recommendations è¡¨
{
  id: string                    // ä¸»é”®
  url: string                   // åŸå§‹ URLï¼ˆè§„èŒƒåŒ–ï¼‰
  title: string
  sourceUrl?: string            // RSS æº URL
  translation?: {               // ç¿»è¯‘æ•°æ®
    translatedTitle: string
    targetLanguage: string
    ...
  }
  urlDecision?: {               // Phase 15: æ–°å¢
    feedAllowsTranslation: boolean
    urlType: 'original' | 'translated'
    originalUrl?: string
    decidedAt: number
  }
  savedToReadingList: boolean
  status: 'active' | 'replaced' | ...
  ...
}

// readingListEntries è¡¨
{
  normalizedUrl: string         // ä¸»é”®ï¼ˆè§„èŒƒåŒ–åçš„ URLï¼‰
  url: string                   // å®é™…ä¿å­˜åˆ°é˜…è¯»æ¸…å•çš„ URL
  recommendationId: string      // å…³è”çš„æ¨è ID
  ...
}
```

### C. æœ¯è¯­è¡¨

- **åŸå§‹ URL**: æ–‡ç« çš„å®é™…é“¾æ¥ï¼Œæ¥è‡ª RSS feed
- **ç¿»è¯‘é“¾æ¥**: é€šè¿‡ Google Translate åŒ…è£…çš„ URL
- **è§„èŒƒåŒ– URL**: ç§»é™¤è¿½è¸ªå‚æ•°å’Œç¿»è¯‘åŒ…è£…åçš„ URL
- **URL å†³ç­–**: ç¡®å®šä½¿ç”¨åŸå§‹ URL è¿˜æ˜¯ç¿»è¯‘é“¾æ¥çš„è¿‡ç¨‹
- **å¿«ç…§**: åœ¨ç‰¹å®šæ—¶é—´ç‚¹ä¿å­˜çš„çŠ¶æ€å‰¯æœ¬
- **å…œåº•æœºåˆ¶**: ä¸»è¦æ–¹æ¡ˆå¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-15  
**ä½œè€…**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å¾…ç”¨æˆ·å®¡æ ¸







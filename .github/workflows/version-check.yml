name: ç‰ˆæœ¬å·æ£€æŸ¥

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  version-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡º PR åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è·å– master åˆ†æ”¯ç‰ˆæœ¬
        id: master-version
        run: |
          git fetch origin master
          MASTER_VERSION=$(git show origin/master:package.json | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "version=$MASTER_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Master ç‰ˆæœ¬: $MASTER_VERSION"
      
      - name: è·å– PR åˆ†æ”¯ç‰ˆæœ¬
        id: pr-version
        run: |
          PR_VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ PR ç‰ˆæœ¬: $PR_VERSION"
      
      - name: åˆ¤æ–­ç‰ˆæœ¬ç±»å‹
        id: version-type
        run: |
          # æ ¹æ® PR æ ‡ç­¾åˆ¤æ–­å»ºè®®çš„ç‰ˆæœ¬ç±»å‹
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "ğŸ·ï¸  PR æ ‡ç­¾: $LABELS"
          
          SUGGESTED_TYPE="patch"
          if [[ "$LABELS" == *"breaking"* ]] || [[ "$LABELS" == *"major"* ]]; then
            SUGGESTED_TYPE="major"
          elif [[ "$LABELS" == *"feature"* ]] || [[ "$LABELS" == *"enhancement"* ]] || [[ "$LABELS" == *"minor"* ]]; then
            SUGGESTED_TYPE="minor"
          fi
          
          # æ ¹æ® PR æ ‡é¢˜åˆ¤æ–­ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
          TITLE="${{ github.event.pull_request.title }}"
          if [[ "$TITLE" =~ ^feat(\(.*\))?!: ]] || [[ "$TITLE" =~ BREAKING ]]; then
            SUGGESTED_TYPE="major"
          elif [[ "$TITLE" =~ ^feat ]]; then
            SUGGESTED_TYPE="minor"
          fi
          
          echo "type=$SUGGESTED_TYPE" >> $GITHUB_OUTPUT
          echo "âœ¨ å»ºè®®ç‰ˆæœ¬ç±»å‹: $SUGGESTED_TYPE"
      
      - name: è®¡ç®—æœŸæœ›ç‰ˆæœ¬å·
        id: expected-version
        run: |
          MASTER_VERSION="${{ steps.master-version.outputs.version }}"
          TYPE="${{ steps.version-type.outputs.type }}"
          
          # è§£æå½“å‰ç‰ˆæœ¬å·
          IFS='.' read -ra VERSION_PARTS <<< "$MASTER_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # è®¡ç®—æ–°ç‰ˆæœ¬å·
          case $TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          EXPECTED_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$EXPECTED_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ¯ æœŸæœ›ç‰ˆæœ¬: $EXPECTED_VERSION"
      
      - name: æ¯”è¾ƒç‰ˆæœ¬å·
        id: compare
        run: |
          MASTER_VERSION="${{ steps.master-version.outputs.version }}"
          PR_VERSION="${{ steps.pr-version.outputs.version }}"
          EXPECTED_VERSION="${{ steps.expected-version.outputs.version }}"
          
          if [ "$PR_VERSION" = "$MASTER_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ç‰ˆæœ¬å·æœªæ›´æ–°"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°: $MASTER_VERSION â†’ $PR_VERSION"
          fi
      
      - name: åˆ›å»ºç‰ˆæœ¬æç¤ºè¯„è®º
        if: steps.compare.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const masterVersion = '${{ steps.master-version.outputs.version }}';
            const prVersion = '${{ steps.pr-version.outputs.version }}';
            const suggestedType = '${{ steps.version-type.outputs.type }}';
            const expectedVersion = '${{ steps.expected-version.outputs.version }}';
            
            const typeDescriptions = {
              'patch': 'ğŸ› Bug ä¿®å¤ï¼ˆ0.4.0 â†’ 0.4.1ï¼‰',
              'minor': 'âœ¨ æ–°åŠŸèƒ½ï¼ˆ0.4.0 â†’ 0.5.0ï¼‰',
              'major': 'ğŸ’¥ ç ´åæ€§å˜æ›´ï¼ˆ0.4.0 â†’ 1.0.0ï¼‰'
            };
            
            const message = `## ğŸ”” ç‰ˆæœ¬å·æé†’
            
å½“å‰ PR æœªæ›´æ–°ç‰ˆæœ¬å·ã€‚

**å½“å‰ç‰ˆæœ¬**: \`${masterVersion}\`  
**å»ºè®®ç±»å‹**: ${typeDescriptions[suggestedType]}  
**å»ºè®®ç‰ˆæœ¬**: \`${expectedVersion}\`

### å¦‚ä½•æ›´æ–°ç‰ˆæœ¬ï¼Ÿ

**æ–¹æ³• 1: ä½¿ç”¨ npm versionï¼ˆæ¨èï¼‰**
\`\`\`bash
npm version ${suggestedType}
git push origin $(git branch --show-current)
\`\`\`

**æ–¹æ³• 2: æ‰‹åŠ¨ç¼–è¾‘ package.json**
\`\`\`json
{
  "version": "${expectedVersion}"
}
\`\`\`

### ç‰ˆæœ¬ç±»å‹è¯´æ˜

- **patch** (0.4.x): Bug ä¿®å¤ã€æ–‡æ¡£æ›´æ–°ã€å°ä¼˜åŒ–
- **minor** (0.x.0): æ–°åŠŸèƒ½ã€å‘åå…¼å®¹çš„æ”¹è¿›
- **major** (x.0.0): ç ´åæ€§å˜æ›´ã€é‡å¤§æ¶æ„è°ƒæ•´

> ğŸ’¡ æç¤ºï¼šä½ å¯ä»¥é€šè¿‡æ·»åŠ æ ‡ç­¾ \`breaking\`ã€\`feature\` æˆ– \`fix\` æ¥å¸®åŠ©è‡ªåŠ¨åˆ¤æ–­ç‰ˆæœ¬ç±»å‹ã€‚`;
            
            // æŸ¥æ‰¾å·²æœ‰çš„ç‰ˆæœ¬æé†’è¯„è®º
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ”” ç‰ˆæœ¬å·æé†’')
            );
            
            if (botComment) {
              // æ›´æ–°å·²æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }
      
      - name: è®¾ç½®æ£€æŸ¥çŠ¶æ€
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          echo "::warning::PR æœªæ›´æ–°ç‰ˆæœ¬å·ã€‚å»ºè®®æ›´æ–°åˆ° ${{ steps.expected-version.outputs.version }} (${{ steps.version-type.outputs.type }})"
          # ä¸é˜»æ­¢ PR åˆå¹¶ï¼Œä»…ä½œä¸ºæé†’
          exit 0
      
      - name: ç‰ˆæœ¬å·²æ›´æ–°
        if: steps.compare.outputs.needs_update == 'false'
        run: |
          echo "âœ… ç‰ˆæœ¬å·å·²æ­£ç¡®æ›´æ–°"

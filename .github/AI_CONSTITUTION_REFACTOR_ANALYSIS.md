# AI 宪法重构分析与方案

## 📊 当前结构问题诊断

### 1. **结构层次混乱**
**问题**：
- "强制执行规则"中混入了"规则 5: 执行前检查"，后者实际上本身就是"执行流程"的描述，而非规则
- "规则 5"的内容（5.1-5.6）与"按场景激活的技能"混在一起，逻辑跳跃
- 优先级表单独放在最后，与规则描述分离太远

**建议**：
- 将"强制执行规则"明确分为两层：**Core Rules**（4 项基础规则）和 **Execution Protocol**（执行流程）
- 优先级表应该直接跟在规则之后，形成"规则定义 → 优先级说明"的紧密关联

---

### 2. **重复与冗余内容**
**问题**：
- "规则 5"的 5.2 段重复列举了"4 项强制执行规则"，这已在"规则 1-4"中定义过
- "按场景激活的技能"中的编号（5、6、7...13）与"强制执行规则"的编号（1-5）混淆，用户难以区分
- "核心原则"部分的第 3、4 点与后文的"技能系统"和"指令"描述重复

**建议**：
- 删除重复列举，用交叉引用替代
- 重新编号场景激活的技能（避免与强制规则编号冲突），或改为列表格式

---

### 3. **规则 vs 流程的混淆**
**问题**：
- 当前称为"规则"的 1-5 项，实际混入了两个不同的概念：
  - **规则 1-4**：真正的"规则"（遵守什么约束）
  - **规则 5**：实际是"执行流程"（如何做检查）
- "按场景激活的技能"应该是"工作流触发规则"，而非"技能列表"

**建议**：
- 将结构改为三层清晰的体系：
  1. **强制执行规则**（4 项核心约束）
  2. **执行前检查协议**（执行流程 6 步，包括真相检验）
  3. **技能激活体系**（什么时候激活哪些技能）

---

### 4. **技能清单的表述问题**
**问题**：
- "按场景激活的技能"列表仍用编号 5-13，与强制规则混淆
- 每个技能的描述不一致：有的是"何时激活 + 作用"，有的只有"作用"
- 没有清楚说明技能之间的**依赖关系**或**执行顺序**（例如：_traceability-check 必须依赖 _change-summary）

**建议**：
- 改用字母或符号标记，避免数字编号冲突
- 统一格式：`**技能名** | 触发条件 | 作用 | 依赖关系`
- 制作一个"技能依赖图"，说明执行顺序

---

### 5. **优先级表的冗余**
**问题**：
- "技能激活的优先级"表与前文的"按场景激活的技能"部分信息重复
- 优先级定义不够精确（何谓"场景激活"？何谓"自动检测"？）

**建议**：
- 合并或彻底分离这两部分
- 制作一个**执行决策树**，清晰说明何时激活哪些技能

---

## 🎯 重构方案（新结构）

### 新的宪法层级

```
AI 系统进化宪法
│
├── Part 1: 核心原则（3 项，删除冗余）
│   ├── 持续学习与自我改进
│   ├── 进化的触发条件
│   └── 技能系统与指令的关系
│
├── Part 2: 强制执行规则（4 项核心约束）
│   ├── Rule 1: 指令守卫 (_instruction-guard)
│   ├── Rule 2: 上下文确认 (_context-ack)
│   ├── Rule 3: 文件输出守卫 (_file-output-guard)
│   └── Rule 4: 会话安全 (_session-safety)
│
├── Part 3: 执行前检查协议（基于规则 4 项的执行流程）
│   ├── 6 步执行流程（现有 5.1-5.6）
│   ├── 输出验证清单
│   └── 补救与自我纠正机制
│
├── Part 4: 技能激活体系
│   ├── 最高优先级：_execution-precheck
│   ├── 强制激活的元技能：_instruction-guard, _context-ack, _file-output-guard, _session-safety
│   ├── 场景激活的工作流技能（附依赖关系）
│   └── 请求激活的专项技能
│
└── Part 5: 通用角色与对话风格
    └── （保持不变或精简）
```

### 具体改动清单

#### 删除/合并
- [ ] 删除"核心原则"中重复的"技能系统"和"指令"描述
- [ ] 删除"规则 5"中 5.2 段的重复列举
- [ ] 合并或整理"按场景激活的技能"与"技能激活优先级"

#### 新增/改进
- [ ] Part 3 中补充"执行前检查协议"的完整描述（从 _execution-precheck 技能中摘取）
- [ ] 制作"技能依赖关系表"或"技能激活决策树"
- [ ] 清晰定义"强制激活"vs"场景激活"vs"请求激活"的判断标准

#### 重新编号
- [ ] 强制规则保持 1-4 编号
- [ ] "执行前检查协议"使用 6 步标记（保持原 5.1-5.6）
- [ ] 技能改用字母或符号，避免数字混淆

---

## 🔄 技能强制执行顺序建议

### Tier 1: 必须强制执行（每次回复）
```
1. _execution-precheck（最高优先，发生在回复生成前）
   ├─ 子步骤 1: 指令加载（使用 _instruction-guard）
   ├─ 子步骤 2-5: 规则验证与格式检查
   └─ 子步骤 6: 真相检验与补救

2. _instruction-guard（指令读取，由 _execution-precheck 触发）
   └─ 结果：确认项目指令已加载

3. _context-ack（输出格式，由 _execution-precheck 触发）
   └─ 结果：每次回复都符合格式规范

4. _file-output-guard（文件操作守卫，由风险评估触发）
   └─ 结果：正确使用工具，分段处理大文件

5. _session-safety（输出长度控制，由风险评估触发）
   └─ 结果：避免超长输出导致失败
```

### Tier 2: 条件强制执行（场景自动触发）
```
A. _evolution-core
   ├─ 触发条件：识别到重复错误、用户反馈、复杂工作流
   ├─ 执行时机：任务评估阶段
   └─ 优先级：立即执行（高于场景激活的其他技能）

B. _code-health-check
   ├─ 触发条件：代码修改完成，准备提交
   ├─ 执行时机：提交前
   └─ 依赖：_file-output-guard（检查文件变更）

C. _typescript-type-safety
   ├─ 触发条件：编写/修改 TypeScript 代码、创建 Mock 数据
   ├─ 执行时机：代码编写/测试阶段
   └─ 依赖：无
```

### Tier 3: 显式请求激活（用户明确要求）
```
1. _git-commit
   ├─ 触发条件：用户请求提交代码
   ├─ 依赖：_change-summary（需要汇总提交摘要）
   └─ 后续：_traceability-check（检查一致性）

2. _pr-creator
   ├─ 触发条件：用户请求创建 PR
   ├─ 依赖：_change-summary, _git-commit
   └─ 后续：_traceability-check

3. _skills-manager
   ├─ 触发条件：用户请求更新/贡献技能
   └─ 依赖：_evolution-core（可能需要）

4. _release-process
   ├─ 触发条件：用户请求发布
   └─ 依赖：_pr-creator, _code-health-check
```

### 执行流程图示

```
每次回复开始
    │
    ├─► _execution-precheck（强制执行）
    │     ├─► _instruction-guard（加载指令）
    │     ├─► 规则验证 & 格式检查
    │     └─► 真相检验 & 补救（失败时）
    │
    ├─► _context-ack（输出格式化）
    │
    ├─► 识别任务类型
    │     ├─ 代码修改？ ──► _typescript-type-safety
    │     ├─ 错误/反馈？ ──► _evolution-core ──► 决定是否改进宪法/技能
    │     └─ 提交前？ ──► _code-health-check
    │
    ├─ 用户显式请求？
    │     ├─ 提交代码 ──► _git-commit ──► _change-summary ──► _traceability-check
    │     ├─ 创建 PR ──► _pr-creator ──► _traceability-check
    │     ├─ 更新技能 ──► _skills-manager
    │     └─ 发布 ──► _release-process
    │
    └─► 生成回复 + 引用清单（使用 _context-ack 格式）
```

---

## 📋 重构优先级

**建议分两阶段**：

### 第 1 阶段：结构优化（必要）
- 清晰分层（Part 1-5）
- 删除重复内容
- 修复编号冲突
- 重新整理技能列表

### 第 2 阶段：深度优化（可选但建议）
- 制作"技能依赖关系表"
- 补充"执行决策树"
- 完整化 Tier 2 和 Tier 3 的触发条件和依赖说明

---

## ✅ 确认点

在执行重构前，需要确认：

1. **是否同意新的三层结构**（规则、协议、技能）？
2. **是否将 _execution-precheck 的内容纳入宪法的"执行前检查协议"部分**？
3. **是否需要制作技能依赖关系图**（Tier 2-3 的执行流程）？
4. **关于强制执行的定义**：
   - 是否认为 _evolution-core 应该在"条件强制"层（自动检测）？
   - 还是应该降为"请求激活"（仅用户显式要求时）？
